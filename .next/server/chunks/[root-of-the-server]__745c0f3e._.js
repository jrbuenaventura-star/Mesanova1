module.exports=[918622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},556704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},832319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},324725,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},270406,(e,t,r)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},193695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},442315,(e,t,r)=>{"use strict";t.exports=e.r(918622)},347540,(e,t,r)=>{"use strict";t.exports=e.r(442315).vendored["react-rsc"].React},423502,(e,t,r)=>{},779314,e=>{"use strict";e.i(423502);var t=e.i(224389);function r(){let e=process.env.SUPABASE_URL||"https://hbzgndpouxhxbhngotru.supabase.co",r=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!r)throw Error("Missing Supabase admin environment variables");return(0,t.createClient)(e,r,{auth:{autoRefreshToken:!1,persistSession:!1},global:{headers:{"X-Client-Info":"mesanova-web-admin@1.0.0"}}})}e.s(["createAdminClient",()=>r])},180833,e=>{"use strict";let t=["company_rif","company_name","business_type","email","full_name","phone","document_type","document_number","discount_percentage","credit_limit","is_active"],r={company_rif:"NIT/RIF de la empresa (obligatorio, clave única para match)",company_name:"Nombre de la empresa (obligatorio)",business_type:"Tipo de negocio (Tienda, Restaurante, Hotel, etc.)",email:"Email del distribuidor (obligatorio para nuevos, se enviará invitación)",full_name:"Nombre completo del contacto",phone:"Teléfono de contacto",document_type:"Tipo de documento (CC, CE, Pasaporte)",document_number:"Número de documento",discount_percentage:"Porcentaje de descuento general (0-100)",credit_limit:"Límite de crédito en pesos",is_active:"Estado activo (SI/NO)"};function i(){return t.join(",")}function a(){let e,i=t.join(","),a=t.map(e=>`"${r[e]}"`).join(","),n=(e={company_rif:"900123456-7",company_name:"Distribuidora Ejemplo S.A.S",business_type:"Tienda",email:"contacto@distribuidora-ejemplo.com",full_name:"Juan Pérez García",phone:"+57 300 123 4567",document_type:"CC",document_number:"1234567890",discount_percentage:"15",credit_limit:"5000000",is_active:"SI"},t.map(t=>{let r=e[t]||"";return r.includes(",")||r.includes('"')?`"${r.replace(/"/g,'""')}"`:r}).join(","));return`${i}
${a}
${n}`}e.s(["BOOLEAN_FIELDS",0,["is_active"],"CSV_HEADERS",0,t,"NUMERIC_FIELDS",0,["discount_percentage","credit_limit"],"REQUIRED_FIELDS",0,["company_rif","company_name"],"REQUIRED_FOR_NEW",0,["email"],"VALID_DOCUMENT_TYPES",0,["CC","CE","Pasaporte","NIT"],"generateCSVWithDescriptions",()=>a,"generateEmptyCSVTemplate",()=>i])},641596,751248,e=>{"use strict";var t=e.i(180833);function r(e){let t=[],r="",i=!1;for(let a=0;a<e.length;a++){let n=e[a],o=e[a+1];'"'===n?i&&'"'===o?(r+='"',a++):i=!i:","!==n||i?r+=n:(t.push(r.trim()),r="")}return t.push(r.trim()),t}function i(e,r,i){let a=[],n=[];for(let r of t.REQUIRED_FIELDS)e[r]&&""!==e[r].trim()||a.push({field:r,message:`El campo ${r} es obligatorio`,value:e[r]||""});if(i)for(let r of t.REQUIRED_FOR_NEW)e[r]&&""!==e[r].trim()||a.push({field:r,message:`El campo ${r} es obligatorio para nuevos distribuidores`,value:e[r]||""});for(let r of(e.email&&""!==e.email.trim()&&(/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e.email.trim())||a.push({field:"email",message:"Email inválido",value:e.email})),t.NUMERIC_FIELDS)){let t=e[r];if(t&&""!==t.trim()){let e=parseFloat(t.replace(/[,$]/g,""));isNaN(e)?a.push({field:r,message:`El campo ${r} debe ser un n\xfamero v\xe1lido`,value:t}):e<0&&a.push({field:r,message:`El campo ${r} no puede ser negativo`,value:t})}}if(e.discount_percentage&&""!==e.discount_percentage.trim()){let t=parseFloat(e.discount_percentage);!isNaN(t)&&(t<0||t>100)&&a.push({field:"discount_percentage",message:"El descuento debe estar entre 0 y 100",value:e.discount_percentage})}for(let r of t.BOOLEAN_FIELDS){let t=e[r]?.toUpperCase();t&&""!==t&&"SI"!==t&&"NO"!==t&&"TRUE"!==t&&"FALSE"!==t&&"1"!==t&&"0"!==t&&a.push({field:r,message:`El campo ${r} debe ser SI/NO`,value:e[r]})}return e.document_type&&""!==e.document_type.trim()&&!t.VALID_DOCUMENT_TYPES.some(t=>t.toLowerCase()===e.document_type.toLowerCase())&&n.push({field:"document_type",message:`Tipo de documento "${e.document_type}" no reconocido. V\xe1lidos: ${t.VALID_DOCUMENT_TYPES.join(", ")}`,value:e.document_type}),e.phone&&""!==e.phone.trim()||n.push({field:"phone",message:"Se recomienda incluir teléfono de contacto",value:""}),{errors:a,warnings:n}}function a(e){let a=e.split(/\r?\n/).filter(e=>""!==e.trim()),n=[],o=[];if(0===a.length)return{success:!1,totalRows:0,validRows:0,invalidRows:0,distributors:[],globalErrors:["El archivo está vacío"]};let s=r(a[0]),l=t.CSV_HEADERS.filter(e=>!s.includes(e)),u=s.filter(e=>!t.CSV_HEADERS.includes(e));l.length>0&&n.push(`Columnas faltantes: ${l.join(", ")}`),u.length>0&&n.push(`Columnas no reconocidas (ser\xe1n ignoradas): ${u.join(", ")}`);let d={};s.forEach((e,t)=>{d[e]=t});let c=1;if(a.length>1){let e=r(a[1])[0]||"";(e.length>50||e.toLowerCase().includes("obligatorio"))&&(c=2)}for(let e=c;e<a.length;e++){let n=a[e];if(""===n.trim())continue;let s=r(n),l={};for(let e of t.CSV_HEADERS){let t=d[e];l[e]=void 0!==t&&s[t]||""}let{errors:u,warnings:c}=i(l,e+1,!0);o.push({row:e+1,data:l,errors:u,warnings:c,isValid:0===u.length})}let p=o.filter(e=>e.isValid).length,m=o.filter(e=>!e.isValid).length;return{success:0===m&&0===n.length,totalRows:o.length,validRows:p,invalidRows:m,distributors:o,globalErrors:n}}function n(e,t){let r=[];for(let a of e){if(!a.isValid)continue;let e=a.data.company_rif.trim(),n=t.get(e);if(n){let t=[];for(let[e,r]of Object.entries({company_rif:"company_rif",company_name:"company_name",business_type:"business_type",email:"_email",full_name:"_full_name",phone:"_phone",document_type:"_document_type",document_number:"_document_number",discount_percentage:"discount_percentage",credit_limit:"credit_limit",is_active:"is_active"})){if(r.startsWith("_"))continue;let i=a.data[e]||"",s=String(n.data[r]||"");o(i,e)!==o(s,e)&&t.push({field:e,oldValue:s||null,newValue:i||null})}t.length>0?r.push({companyRif:e,changeType:"update",changes:t,existingId:n.id,existingUserId:n.user_id}):r.push({companyRif:e,changeType:"unchanged",changes:[],existingId:n.id,existingUserId:n.user_id})}else{let{errors:t}=i(a.data,a.row,!0);t.length>0&&(a.errors=t,a.isValid=!1),r.push({companyRif:e,changeType:"create",changes:[]})}}return r}function o(e,r){if(!e)return"";if(t.BOOLEAN_FIELDS.includes(r)){let t=e.toUpperCase();return"SI"===t||"TRUE"===t||"1"===t?"true":"NO"===t||"FALSE"===t||"0"===t?"false":e.toLowerCase()}if(t.NUMERIC_FIELDS.includes(r)){let t=parseFloat(e.replace(/[,$]/g,""));return isNaN(t)?"":t.toString()}return e.trim().toLowerCase()}function s(e){if(!e)return!0;let t=e.toUpperCase();return"SI"===t||"TRUE"===t||"1"===t}function l(e){if(!e||""===e.trim())return null;let t=parseFloat(e.replace(/[,$]/g,""));return isNaN(t)?null:t}e.s(["compareWithExisting",()=>n,"parseBooleanValue",()=>s,"parseCSV",()=>a,"parseNumericValue",()=>l],641596);var u=e.i(779314);async function d(e,t,r,i,a){let n=(0,u.createAdminClient)(),o=[],s=0,l=0,d=0,m=0,{data:_,error:f}=await n.from("distributor_csv_imports").insert({filename:a,total_rows:e.length,status:"processing",import_mode:r,imported_by:i,started_at:new Date().toISOString()}).select("id").single(),h=_?.id||`temp-${Date.now()}`;for(let i=0;i<e.length;i++){let a=e[i],u=t.find(e=>e.companyRif===a.data.company_rif.trim());if(!a.isValid||!u){d++;continue}try{"create"===u.changeType?((await c(n,a.data)).invited&&m++,s++):"update"===u.changeType?"add_only"===r?d++:(await p(n,a.data,u),l++):d++}catch(e){o.push({row:a.row,companyRif:a.data.company_rif,error:e instanceof Error?e.message:"Error desconocido"})}}return _?.id&&await n.from("distributor_csv_imports").update({rows_created:s,rows_updated:l,rows_skipped:d,rows_invited:m,rows_error:o.length,errors:o.length>0?o:null,status:0===o.length?"completed":"completed_with_errors",completed_at:new Date().toISOString()}).eq("id",_.id),{success:0===o.length,importId:h,created:s,updated:l,skipped:d,invited:m,errors:o}}async function c(e,t){let r,i=t.email.trim().toLowerCase(),{data:a}=await e.auth.admin.listUsers(),n=a?.users?.find(e=>e.email?.toLowerCase()===i),o=!1;if(n)r=n.id;else{let{data:a,error:n}=await e.auth.admin.inviteUserByEmail(i,{data:{role:"distributor",full_name:t.full_name},redirectTo:"http://localhost:3000/auth/callback"});if(n)throw Error(`Error invitando usuario: ${n.message}`);if(!a.user)throw Error("No se pudo crear el usuario");r=a.user.id,o=!0}let{error:u}=await e.from("user_profiles").upsert({id:r,role:"distributor",full_name:t.full_name||null,phone:t.phone||null,document_type:t.document_type||null,document_number:t.document_number||null});if(u)throw Error(`Error creando perfil: ${u.message}`);let{error:d}=await e.from("distributors").insert({user_id:r,company_name:t.company_name,company_rif:t.company_rif,business_type:t.business_type||null,discount_percentage:l(t.discount_percentage)||0,credit_limit:l(t.credit_limit)||0,is_active:s(t.is_active)});if(d)throw Error(`Error creando distribuidor: ${d.message}`);return{invited:o}}async function p(e,t,r){let{error:i}=await e.from("distributors").update({company_name:t.company_name,business_type:t.business_type||null,discount_percentage:l(t.discount_percentage)||0,credit_limit:l(t.credit_limit)||0,is_active:s(t.is_active),updated_at:new Date().toISOString()}).eq("company_rif",t.company_rif.trim());if(i)throw Error(`Error actualizando distribuidor: ${i.message}`);if(r.existingUserId){let i={};t.full_name&&(i.full_name=t.full_name),t.phone&&(i.phone=t.phone),t.document_type&&(i.document_type=t.document_type),t.document_number&&(i.document_number=t.document_number),Object.keys(i).length>0&&await e.from("user_profiles").update(i).eq("id",r.existingUserId)}}async function m(e){let{data:t}=await e.from("distributors").select("*"),r=new Map;if(t)for(let e of t)e.company_rif&&r.set(e.company_rif,{id:e.id,user_id:e.user_id,data:e});return r}e.s(["getExistingDistributorsMap",()=>m,"importDistributors",()=>d],751248)},448323,e=>{"use strict";var t=e.i(747909),r=e.i(174017),i=e.i(996250),a=e.i(759756),n=e.i(561916),o=e.i(114444),s=e.i(837092),l=e.i(869741),u=e.i(316795),d=e.i(487718),c=e.i(995169),p=e.i(47587),m=e.i(666012),_=e.i(570101),f=e.i(626937),h=e.i(10372),g=e.i(193695);e.i(52474);var E=e.i(257297),v=e.i(89171),y=e.i(89660),R=e.i(779314),b=e.i(641596),w=e.i(751248);async function x(e){try{let t=await (0,y.createClient)(),{data:{user:r},error:i}=await t.auth.getUser();if(i||!r)return v.NextResponse.json({error:"No autorizado"},{status:401});let{data:a}=await t.from("user_profiles").select("role").eq("id",r.id).single();if(a?.role!=="superadmin")return v.NextResponse.json({error:"No autorizado"},{status:403});let n=await e.formData(),o=n.get("file"),s=n.get("mode")||"update";if(!o)return v.NextResponse.json({error:"No se proporcionó archivo"},{status:400});if(!["update","add_only"].includes(s))return v.NextResponse.json({error:"Modo de importación inválido"},{status:400});let l=await o.text(),u=(0,b.parseCSV)(l),d=(0,R.createAdminClient)(),c=await (0,w.getExistingDistributorsMap)(d),p=(0,b.compareWithExisting)(u.distributors,c);for(let e of u.distributors){let t=p.find(t=>t.companyRif===e.data.company_rif.trim());t?.changeType!=="create"||e.data.email&&""!==e.data.email.trim()||(e.errors.push({field:"email",message:"Email obligatorio para nuevos distribuidores",value:""}),e.isValid=!1)}let m=u.distributors.filter(e=>!e.isValid).length;if(m>0)return v.NextResponse.json({success:!1,error:"El archivo contiene errores de validación",invalidRows:m,distributors:u.distributors.filter(e=>!e.isValid).slice(0,20)},{status:400});let _=await (0,w.importDistributors)(u.distributors,p,s,r.id,o.name);return v.NextResponse.json({success:_.success,importId:_.importId,created:_.created,updated:_.updated,skipped:_.skipped,invited:_.invited,errors:_.errors.slice(0,20),hasMoreErrors:_.errors.length>20})}catch(e){return console.error("Error importando CSV de distribuidores:",e),v.NextResponse.json({error:"Error al importar archivo CSV"},{status:500})}}e.s(["POST",()=>x],718382);var C=e.i(718382);let S=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/distributors/csv/import/route",pathname:"/api/distributors/csv/import",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/distributors/csv/import/route.ts",nextConfigOutput:"",userland:C}),{workAsyncStorage:N,workUnitAsyncStorage:I,serverHooks:T}=S;function A(){return(0,i.patchFetch)({workAsyncStorage:N,workUnitAsyncStorage:I})}async function D(e,t,i){S.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let v="/api/distributors/csv/import/route";v=v.replace(/\/index$/,"")||"/";let y=await S.prepare(e,t,{srcPage:v,multiZoneDraftMode:!1});if(!y)return t.statusCode=400,t.end("Bad Request"),null==i.waitUntil||i.waitUntil.call(i,Promise.resolve()),null;let{buildId:R,params:b,nextConfig:w,parsedUrl:x,isDraftMode:C,prerenderManifest:N,routerServerContext:I,isOnDemandRevalidate:T,revalidateOnlyGenerated:A,resolvedPathname:D,clientReferenceManifest:O,serverActionsManifest:U}=y,j=(0,l.normalizeAppPath)(v),P=!!(N.dynamicRoutes[j]||N.routes[D]),$=async()=>((null==I?void 0:I.render404)?await I.render404(e,t,x,!1):t.end("This page could not be found"),null);if(P&&!C){let e=!!N.routes[D],t=N.dynamicRoutes[j];if(t&&!1===t.fallback&&!e){if(w.experimental.adapterPath)return await $();throw new g.NoFallbackError}}let L=null;!P||S.isDev||C||(L="/index"===(L=D)?"/":L);let V=!0===S.isDev||!P,M=P&&!V;U&&O&&(0,o.setReferenceManifestsSingleton)({page:v,clientReferenceManifest:O,serverActionsManifest:U,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:U})});let k=e.method||"GET",F=(0,n.getTracer)(),q=F.getActiveScopeSpan(),H={params:b,prerenderManifest:N,renderOpts:{experimental:{authInterrupts:!!w.experimental.authInterrupts},cacheComponents:!!w.cacheComponents,supportsDynamicResponse:V,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:w.cacheLife,waitUntil:i.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,i)=>S.onRequestError(e,t,i,I)},sharedContext:{buildId:R}},B=new u.NodeNextRequest(e),K=new u.NodeNextResponse(t),W=d.NextRequestAdapter.fromNodeNextRequest(B,(0,d.signalFromNodeResponse)(t));try{let o=async e=>S.handle(W,H).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=F.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=r.get("next.route");if(i){let t=`${k} ${i}`;e.setAttributes({"next.route":i,"http.route":i,"next.span_name":t}),e.updateName(t)}else e.updateName(`${k} ${v}`)}),s=!!(0,a.getRequestMeta)(e,"minimalMode"),l=async a=>{var n,l;let u=async({previousCacheEntry:r})=>{try{if(!s&&T&&A&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await o(a);e.fetchMetrics=H.renderOpts.fetchMetrics;let l=H.renderOpts.pendingWaitUntil;l&&i.waitUntil&&(i.waitUntil(l),l=void 0);let u=H.renderOpts.collectedTags;if(!P)return await (0,m.sendResponse)(B,K,n,H.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,_.toNodeOutgoingHttpHeaders)(n.headers);u&&(t[h.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==H.renderOpts.collectedRevalidate&&!(H.renderOpts.collectedRevalidate>=h.INFINITE_CACHE)&&H.renderOpts.collectedRevalidate,i=void 0===H.renderOpts.collectedExpire||H.renderOpts.collectedExpire>=h.INFINITE_CACHE?void 0:H.renderOpts.collectedExpire;return{value:{kind:E.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:i}}}}catch(t){throw(null==r?void 0:r.isStale)&&await S.onRequestError(e,t,{routerKind:"App Router",routePath:v,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:T})},I),t}},d=await S.handleResponse({req:e,nextConfig:w,cacheKey:L,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:N,isRoutePPREnabled:!1,isOnDemandRevalidate:T,revalidateOnlyGenerated:A,responseGenerator:u,waitUntil:i.waitUntil,isMinimalMode:s});if(!P)return null;if((null==d||null==(n=d.value)?void 0:n.kind)!==E.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",T?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),C&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let c=(0,_.fromNodeOutgoingHttpHeaders)(d.value.headers);return s&&P||c.delete(h.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||c.get("Cache-Control")||c.set("Cache-Control",(0,f.getCacheControlHeader)(d.cacheControl)),await (0,m.sendResponse)(B,K,new Response(d.value.body,{headers:c,status:d.value.status||200})),null};q?await l(q):await F.withPropagatedContext(e.headers,()=>F.trace(c.BaseServerSpan.handleRequest,{spanName:`${k} ${v}`,kind:n.SpanKind.SERVER,attributes:{"http.method":k,"http.target":e.url}},l))}catch(t){if(t instanceof g.NoFallbackError||await S.onRequestError(e,t,{routerKind:"App Router",routePath:j,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:T})}),P)throw t;return await (0,m.sendResponse)(B,K,new Response(null,{status:500})),null}}e.s(["handler",()=>D,"patchFetch",()=>A,"routeModule",()=>S,"serverHooks",()=>T,"workAsyncStorage",()=>N,"workUnitAsyncStorage",()=>I],448323)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__745c0f3e._.js.map