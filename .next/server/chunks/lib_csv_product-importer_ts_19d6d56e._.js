module.exports=[178805,476889,e=>{"use strict";var a=e.i(89660),i=e.i(188248);function o(e){let a=[],i="",o=!1;for(let t=0;t<e.length;t++){let r=e[t],n=e[t+1];'"'===r?o&&'"'===n?(i+='"',t++):o=!o:","!==r||o?i+=r:(a.push(i.trim()),i="")}return a.push(i.trim()),a}function t(e){let a=e.split(/\r?\n/).filter(e=>""!==e.trim()),t=[],r=[];if(0===a.length)return{success:!1,totalRows:0,validRows:0,invalidRows:0,products:[],globalErrors:["El archivo está vacío"]};let n=o(a[0]),s=i.CSV_HEADERS.filter(e=>!n.includes(e)),c=n.filter(e=>!i.CSV_HEADERS.includes(e));s.length>0&&t.push(`Columnas faltantes: ${s.join(", ")}`),c.length>0&&t.push(`Columnas no reconocidas (ser\xe1n ignoradas): ${c.join(", ")}`);let d={};n.forEach((e,a)=>{d[e]=a});let l=1;if(a.length>1){let e=o(a[1])[0]||"";(e.length>50||e.toLowerCase().includes("obligatorio"))&&(l=2)}for(let e=l;e<a.length;e++){let t=a[e];if(""===t.trim())continue;let n=o(t),s={};for(let e of i.CSV_HEADERS){let a=d[e];s[e]=void 0!==a&&n[a]||""}let{errors:c,warnings:l}=function(e,a){let o=[],t=[];for(let a of i.REQUIRED_FIELDS)e[a]&&""!==e[a].trim()||o.push({field:a,message:`El campo ${a} es obligatorio`,value:e[a]||""});for(let a of i.NUMERIC_FIELDS){let i=e[a];if(i&&""!==i.trim()){let e=parseFloat(i.replace(/[,$]/g,""));isNaN(e)?o.push({field:a,message:`El campo ${a} debe ser un n\xfamero v\xe1lido`,value:i}):e<0&&o.push({field:a,message:`El campo ${a} no puede ser negativo`,value:i})}}for(let a of i.BOOLEAN_FIELDS){let i=e[a]?.toUpperCase();i&&""!==i&&"SI"!==i&&"NO"!==i&&"TRUE"!==i&&"FALSE"!==i&&"1"!==i&&"0"!==i&&o.push({field:a,message:`El campo ${a} debe ser SI/NO`,value:e[a]})}if(e.Categoria&&""!==e.Categoria.trim()){let a=e.Categoria.trim();i.VALID_CATEGORIES.some(e=>e.toLowerCase()===a.toLowerCase())||t.push({field:"Categoria",message:`Categor\xeda "${a}" no reconocida. V\xe1lidas: ${i.VALID_CATEGORIES.join(", ")}`,value:e.Categoria})}if(e.Rotacion_Esperada&&""!==e.Rotacion_Esperada.trim()){let a=e.Rotacion_Esperada.toLowerCase().trim();i.VALID_ROTACION.includes(a)||o.push({field:"Rotacion_Esperada",message:`Rotaci\xf3n debe ser: ${i.VALID_ROTACION.join(", ")}`,value:e.Rotacion_Esperada})}if(e.Descuento&&""!==e.Descuento.trim()){let a=parseFloat(e.Descuento);!isNaN(a)&&(a<0||a>100)&&o.push({field:"Descuento",message:"El descuento debe estar entre 0 y 100",value:e.Descuento})}if(e.Margen_Sugerido&&""!==e.Margen_Sugerido.trim()){let a=parseFloat(e.Margen_Sugerido);!isNaN(a)&&(a<0||a>100)&&t.push({field:"Margen_Sugerido",message:"El margen sugerido parece fuera de rango normal (0-100%)",value:e.Margen_Sugerido})}for(let a of(e.Fecha_Lanzamiento&&""!==e.Fecha_Lanzamiento.trim()&&(/^\d{4}-\d{2}-\d{2}$/.test(e.Fecha_Lanzamiento)?isNaN(new Date(e.Fecha_Lanzamiento).getTime())&&o.push({field:"Fecha_Lanzamiento",message:"Fecha inválida",value:e.Fecha_Lanzamiento}):o.push({field:"Fecha_Lanzamiento",message:"La fecha debe tener formato YYYY-MM-DD",value:e.Fecha_Lanzamiento})),["Image_1","Image_2","Image_3","Image_4","Image_5","Image_6","Image_7","Image_8","Image_9","Image_10"])){let i=e[a];if(i&&""!==i.trim())try{new URL(i)}catch{o.push({field:a,message:"URL de imagen inválida",value:i})}}if(e.Video_URL&&""!==e.Video_URL.trim())try{new URL(e.Video_URL)}catch{o.push({field:"Video_URL",message:"URL de video inválida",value:e.Video_URL})}if(e.Ficha_Tecnica_URL&&""!==e.Ficha_Tecnica_URL.trim())try{new URL(e.Ficha_Tecnica_URL)}catch{o.push({field:"Ficha_Tecnica_URL",message:"URL de ficha técnica inválida",value:e.Ficha_Tecnica_URL})}return e.Image_1&&""!==e.Image_1.trim()||t.push({field:"Image_1",message:"Se recomienda incluir al menos una imagen",value:""}),{errors:o,warnings:t}}(s,0);r.push({row:e+1,data:s,errors:c,warnings:l,isValid:0===c.length})}let _=r.filter(e=>e.isValid).length,u=r.filter(e=>!e.isValid).length;return{success:0===u&&0===t.length,totalRows:r.length,validRows:_,invalidRows:u,products:r,globalErrors:t}}function r(e,a){let i=[];for(let o of e){if(!o.isValid)continue;let e=o.data.Ref,t=a.get(e);if(t){let a=[];for(let[e,i]of Object.entries({Ref:"pdt_codigo",Cod_Barra:"codigo_barras",Producto:"nombre_comercial",Descripcion:"pdt_descripcion",Marca:"marca",Precio_COP:"precio",Descuento:"descuento_porcentaje",Existencia_inv:"upp_existencia",Pedido_en_camino:"pedido_en_camino",Descontinuado:"descontinuado",Inner_pack:"pdt_empaque",Outer_pack:"outer_pack",Coleccion:"nombre_coleccion",Categoria:"_category",Subcategoria:"_subcategory",Tipo_producto:"_type",Material:"material",Color:"color",Dimensiones:"dimensiones",Peso_kg:"peso",Capacidad:"capacidad",Pais_origen:"pais_origen",Descrip_Cliente_Final:"descripcion_larga",Momentos_Uso_Cliente:"momentos_uso",Productos_Afines_Cliente:"productos_afines_csv",Descrip_Distribuidor:"descripcion_distribuidor",Argumentos_Venta_Distribuidor:"argumentos_venta",Ubicacion_Tienda_Distribuidor:"ubicacion_tienda",Margen_Sugerido:"margen_sugerido",Rotacion_Esperada:"rotacion_esperada",SEO_Title:"seo_title",SEO_Description:"seo_description",Tags:"tags",Video_URL:"video_url",Ficha_Tecnica_URL:"ficha_tecnica_url",Fecha_Lanzamiento:"fecha_lanzamiento",Image_1:"imagen_principal_url",Image_2:"_image_2",Image_3:"_image_3",Image_4:"_image_4",Image_5:"_image_5",Image_6:"_image_6",Image_7:"_image_7",Image_8:"_image_8",Image_9:"_image_9",Image_10:"_image_10"})){if(i.startsWith("_"))continue;let r=o.data[e]||"",s=String(t[i]||"");n(r,e)!==n(s,e)&&a.push({field:e,oldValue:s||null,newValue:r||null})}a.length>0?i.push({ref:e,changeType:"update",changes:a}):i.push({ref:e,changeType:"unchanged",changes:[]})}else i.push({ref:e,changeType:"create",changes:[]})}return i}function n(e,a){if(!e)return"";if(i.BOOLEAN_FIELDS.includes(a)){let a=e.toUpperCase();return"SI"===a||"TRUE"===a||"1"===a?"true":"NO"===a||"FALSE"===a||"0"===a?"false":e.toLowerCase()}if(i.NUMERIC_FIELDS.includes(a)){let a=parseFloat(e.replace(/[,$]/g,""));return isNaN(a)?"":a.toString()}return e.trim().toLowerCase()}function s(e){let a=(e||"").toUpperCase().trim();return"SI"===a||"TRUE"===a||"1"===a||"YES"===a}function c(e){if(!e||""===e.trim())return null;let a=parseFloat(e.replace(/[,$]/g,""));return isNaN(a)?null:a}async function d(e,i,o,t,r){let n=await (0,a.createClient)(),s=[],c=0,d=0,_=0,{data:m,error:g}=await n.from("csv_imports").insert({filename:r,total_rows:e.length,status:"processing",import_mode:o,imported_by:t,started_at:new Date().toISOString()}).select("id").single();if(g||!m)return{success:!1,importId:"",created:0,updated:0,skipped:0,errors:[{row:0,ref:"",error:"Error al crear registro de importación"}]};let f=m.id,h=await l(n);for(let a=0;a<e.length;a++){let r=e[a],l=i.find(e=>e.ref===r.data.Ref);if(!r.isValid||!l){_++;continue}try{"create"===l.changeType?(await u(n,r.data,h,t,f,r.row),c++):"update"===l.changeType?"add_only"===o?_++:(await p(n,r.data,l,h,t,f,r.row),d++):_++}catch(e){s.push({row:r.row,ref:r.data.Ref,error:e instanceof Error?e.message:"Error desconocido"})}}return await n.from("csv_imports").update({rows_created:c,rows_updated:d,rows_skipped:_,rows_error:s.length,errors:s.length>0?s:null,status:0===s.length?"completed":"completed_with_errors",completed_at:new Date().toISOString()}).eq("id",f),{success:0===s.length,importId:f,created:c,updated:d,skipped:_,errors:s}}async function l(e){let a=new Map,{data:i}=await e.from("silos").select("id, slug, name"),{data:o}=await e.from("subcategories").select("id, slug, name, silo_id"),{data:t}=await e.from("product_types").select("id, slug, name, subcategory_id");if(i&&o)for(let e of i)for(let i of o.filter(a=>a.silo_id===e.id)){let o=`${e.name.toLowerCase()}|${i.name.toLowerCase()}`;if(a.set(o,{siloId:e.id,subcategoryId:i.id}),t)for(let o of t.filter(e=>e.subcategory_id===i.id)){let t=`${e.name.toLowerCase()}|${i.name.toLowerCase()}|${o.name.toLowerCase()}`;a.set(t,{siloId:e.id,subcategoryId:i.id,productTypeId:o.id})}}return a}function _(e,a){let i=e.Categoria?.toLowerCase().trim()||"",o=e.Subcategoria?.toLowerCase().trim()||"",t=e.Tipo_producto?.toLowerCase().trim()||"";if(t){let e=`${i}|${o}|${t}`,r=a.get(e);if(r)return r}if(o){let e=`${i}|${o}`,t=a.get(e);if(t)return t}return null}async function u(e,a,i,o,t,r){let n=a.Producto.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,""),d=_(a,i),{data:l,error:u}=await e.from("products").insert({pdt_codigo:a.Ref,codigo_barras:a.Cod_Barra||null,nombre_comercial:a.Producto,pdt_descripcion:a.Descripcion||null,marca:a.Marca||null,precio:c(a.Precio_COP),descuento_porcentaje:c(a.Descuento)||0,upp_existencia:c(a.Existencia_inv)||0,pedido_en_camino:s(a.Pedido_en_camino),descontinuado:s(a.Descontinuado),pdt_empaque:a.Inner_pack||null,outer_pack:c(a.Outer_pack),nombre_coleccion:a.Coleccion||null,product_type_id:d?.productTypeId||null,material:a.Material||null,color:a.Color||null,dimensiones:a.Dimensiones||null,peso:c(a.Peso_kg),capacidad:a.Capacidad||null,pais_origen:a.Pais_origen||null,descripcion_larga:a.Descrip_Cliente_Final||null,momentos_uso:a.Momentos_Uso_Cliente||null,productos_afines_csv:a.Productos_Afines_Cliente||null,descripcion_distribuidor:a.Descrip_Distribuidor||null,argumentos_venta:a.Argumentos_Venta_Distribuidor||null,ubicacion_tienda:a.Ubicacion_Tienda_Distribuidor||null,margen_sugerido:c(a.Margen_Sugerido),rotacion_esperada:a.Rotacion_Esperada?.toLowerCase()||null,seo_title:a.SEO_Title||null,seo_description:a.SEO_Description||null,tags:a.Tags?a.Tags.split(",").map(e=>e.trim()):null,video_url:a.Video_URL||null,ficha_tecnica_url:a.Ficha_Tecnica_URL||null,fecha_lanzamiento:a.Fecha_Lanzamiento||null,imagen_principal_url:a.Image_1||null,slug:n,is_active:!0,is_on_sale:(c(a.Descuento)||0)>0,last_csv_update:new Date().toISOString(),created_by:o,updated_by:o}).select("id").single();if(u)throw Error(`Error creando producto: ${u.message}`);l&&d&&await e.from("product_categories").insert({product_id:l.id,subcategory_id:d.subcategoryId,is_primary:!0}),l&&await m(e,l.id,a),await e.from("product_change_log").insert({product_id:l?.id,change_type:"create",change_source:"csv",fields_changed:{all:"new product"},changed_by:o,csv_filename:t,csv_row_number:r})}async function p(e,a,i,o,t,r,n){let{data:d}=await e.from("products").select("id").eq("pdt_codigo",a.Ref).single();if(!d)throw Error("Producto no encontrado para actualizar");let l=d.id,u=_(a,o),p={updated_by:t,last_csv_update:new Date().toISOString(),is_on_sale:(c(a.Descuento)||0)>0},g={Cod_Barra:{dbField:"codigo_barras"},Producto:{dbField:"nombre_comercial"},Descripcion:{dbField:"pdt_descripcion"},Marca:{dbField:"marca"},Precio_COP:{dbField:"precio",transform:c},Descuento:{dbField:"descuento_porcentaje",transform:e=>c(e)||0},Existencia_inv:{dbField:"upp_existencia",transform:e=>c(e)||0},Pedido_en_camino:{dbField:"pedido_en_camino",transform:s},Descontinuado:{dbField:"descontinuado",transform:s},Inner_pack:{dbField:"pdt_empaque"},Outer_pack:{dbField:"outer_pack",transform:c},Coleccion:{dbField:"nombre_coleccion"},Material:{dbField:"material"},Color:{dbField:"color"},Dimensiones:{dbField:"dimensiones"},Peso_kg:{dbField:"peso",transform:c},Capacidad:{dbField:"capacidad"},Pais_origen:{dbField:"pais_origen"},Descrip_Cliente_Final:{dbField:"descripcion_larga"},Momentos_Uso_Cliente:{dbField:"momentos_uso"},Productos_Afines_Cliente:{dbField:"productos_afines_csv"},Descrip_Distribuidor:{dbField:"descripcion_distribuidor"},Argumentos_Venta_Distribuidor:{dbField:"argumentos_venta"},Ubicacion_Tienda_Distribuidor:{dbField:"ubicacion_tienda"},Margen_Sugerido:{dbField:"margen_sugerido",transform:c},Rotacion_Esperada:{dbField:"rotacion_esperada",transform:e=>e?.toLowerCase()||null},SEO_Title:{dbField:"seo_title"},SEO_Description:{dbField:"seo_description"},Tags:{dbField:"tags",transform:e=>e?e.split(",").map(e=>e.trim()):null},Video_URL:{dbField:"video_url"},Ficha_Tecnica_URL:{dbField:"ficha_tecnica_url"},Fecha_Lanzamiento:{dbField:"fecha_lanzamiento"},Image_1:{dbField:"imagen_principal_url"}};for(let e of i.changes){let i=g[e.field];if(i){let o=a[e.field];p[i.dbField]=i.transform?i.transform(o):o||null}}let{error:f}=await e.from("products").update(p).eq("id",l);if(f)throw Error(`Error actualizando producto: ${f.message}`);u?.productTypeId&&await e.from("products").update({product_type_id:u.productTypeId}).eq("id",l),i.changes.filter(e=>e.field.startsWith("Image_")).length>0&&(await e.from("product_media").delete().eq("product_id",l),await m(e,l,a));let h={};for(let e of i.changes)h[e.field]={old:e.oldValue,new:e.newValue};await e.from("product_change_log").insert({product_id:l,change_type:"update",change_source:"csv",fields_changed:h,changed_by:t,csv_filename:r,csv_row_number:n})}async function m(e,a,i){let o=[],t=["Image_2","Image_3","Image_4","Image_5","Image_6","Image_7","Image_8","Image_9","Image_10"];for(let e=0;e<t.length;e++){let r=i[t[e]];r&&""!==r.trim()&&o.push({product_id:a,media_type:"image",url:r.trim(),order_index:e+2})}o.length>0&&await e.from("product_media").insert(o)}async function g(e){let{data:a}=await e.from("products").select("*"),i=new Map;if(a)for(let e of a)i.set(e.pdt_codigo,e);return i}async function f(a){let{data:i}=await a.from("products").select(`
      *,
      product_categories!inner(
        subcategory:subcategories(
          name,
          silo:silos(name)
        )
      ),
      product_type:product_types(name),
      product_media(url, order_index)
    `).order("pdt_codigo");if(!i||0===i.length)return"";let{CSV_HEADERS:o}=await e.A(62689),t=[o.join(",")];for(let e of i){let a=e.product_categories?.[0]?.subcategory,i=e.product_media?.sort((e,a)=>e.order_index-a.order_index)||[],o=[h(e.pdt_codigo||""),h(e.codigo_barras||""),h(e.nombre_comercial||""),h(e.pdt_descripcion||""),h(e.marca||""),String(e.precio||""),String(e.descuento_porcentaje||"0"),String(e.upp_existencia||"0"),e.pedido_en_camino?"SI":"NO",e.descontinuado?"SI":"NO",h(e.pdt_empaque||""),String(e.outer_pack||""),h(e.nombre_coleccion||""),h(a?.silo?.name||""),h(a?.name||""),h(e.product_type?.name||""),h(e.material||""),h(e.color||""),h(e.dimensiones||""),String(e.peso||""),h(e.capacidad||""),h(e.pais_origen||""),h(e.descripcion_larga||""),h(e.momentos_uso||""),h(e.productos_afines_csv||""),h(e.descripcion_distribuidor||""),h(e.argumentos_venta||""),h(e.ubicacion_tienda||""),String(e.margen_sugerido||""),h(e.rotacion_esperada||""),h(e.seo_title||""),h(e.seo_description||""),h((e.tags||[]).join(",")),h(e.video_url||""),h(e.ficha_tecnica_url||""),h(e.fecha_lanzamiento||""),h(e.imagen_principal_url||""),...Array.from({length:9},(e,a)=>{let o=i.find(e=>e.order_index===a+2);return h(o?.url||"")})];t.push(o.join(","))}return t.join("\n")}function h(e){return e?e.includes(",")||e.includes('"')||e.includes("\n")?`"${e.replace(/"/g,'""')}"`:e:""}e.s(["compareWithExisting",()=>r,"parseBooleanValue",()=>s,"parseCSV",()=>t,"parseNumericValue",()=>c],476889),e.s(["exportProductsToCSV",()=>f,"getExistingProductsMap",()=>g,"importProducts",()=>d],178805)}];

//# sourceMappingURL=lib_csv_product-importer_ts_19d6d56e._.js.map