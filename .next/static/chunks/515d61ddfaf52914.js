(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,184762,e=>{"use strict";var a=e.i(843476),t=e.i(647163);function s({className:e,...s}){return(0,a.jsx)("textarea",{"data-slot":"textarea",className:(0,t.cn)("border-input placeholder:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 flex field-sizing-content min-h-16 w-full rounded-md border bg-transparent px-3 py-2 text-base shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",e),...s})}e.s(["Textarea",()=>s])},269638,e=>{"use strict";let a=(0,e.i(475254).default)("CircleCheckBig",[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]);e.s(["CheckCircle",()=>a],269638)},342920,e=>{"use strict";let a=(0,e.i(475254).default)("Building",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",ry:"2",key:"76otgf"}],["path",{d:"M9 22v-4h6v4",key:"r93iot"}],["path",{d:"M8 6h.01",key:"1dz90k"}],["path",{d:"M16 6h.01",key:"1x0f13"}],["path",{d:"M12 6h.01",key:"1vi96p"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M8 14h.01",key:"6423bh"}]]);e.s(["Building",()=>a],342920)},503116,e=>{"use strict";let a=(0,e.i(475254).default)("Clock",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["polyline",{points:"12 6 12 12 16 14",key:"68esgv"}]]);e.s(["Clock",()=>a],503116)},878894,e=>{"use strict";let a=(0,e.i(475254).default)("TriangleAlert",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]]);e.s(["AlertTriangle",()=>a],878894)},369168,e=>{"use strict";var a=e.i(843476),t=e.i(271645),s=e.i(401851),r=e.i(677241),i=e.i(55545),l=e.i(455024),n=e.i(99151),o=e.i(845110),d=e.i(281092);function c(e,a){let t=(0,d.toDate)(e)-(0,d.toDate)(a);return t<0?-1:t>0?1:t}var m=e.i(234662),h=e.i(564211),u=e.i(878894),x=e.i(63209),f=e.i(503116),g=e.i(269638),j=e.i(16715),p=e.i(475254);let v=(0,p.default)("Bell",[["path",{d:"M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9",key:"1qo2s2"}],["path",{d:"M10.3 21a1.94 1.94 0 0 0 3.4 0",key:"qgo35s"}]]),N=(0,p.default)("BellOff",[["path",{d:"M8.7 3A6 6 0 0 1 18 8a21.3 21.3 0 0 0 .6 5",key:"o7mx20"}],["path",{d:"M17 17H3s3-2 3-9a4.67 4.67 0 0 1 .3-1.7",key:"16f1lm"}],["path",{d:"M10.3 21a1.94 1.94 0 0 0 3.4 0",key:"qgo35s"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);var b=e.i(342920);let y=(0,p.default)("MessageSquare",[["path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z",key:"1lielz"}]]);var C=e.i(970065),w=e.i(994179),M=e.i(167881),D=e.i(184762),k=e.i(630374),_=e.i(127341);function T({showGenerateButton:e=!1}){let[p,T]=(0,t.useState)([]),[S,A]=(0,t.useState)({total:0,warning:0,critical:0,dormant:0}),[B,z]=(0,t.useState)(!0),[O,R]=(0,t.useState)(!1),[I,X]=(0,t.useState)("unresolved"),[H,$]=(0,t.useState)(null),[E,Y]=(0,t.useState)(!1),[q,F]=(0,t.useState)(""),[P,L]=(0,t.useState)(!1);(0,t.useEffect)(()=>{U()},[I]);let U=async()=>{z(!0);try{let e=new URLSearchParams;"unresolved"===I&&e.set("unresolved","true");let a=await fetch(`/api/alerts/distributors?${e}`),t=await a.json();a.ok&&(T(t.alerts||[]),A(t.stats||{total:0,warning:0,critical:0,dormant:0}))}catch(e){console.error("Error fetching alerts:",e)}finally{z(!1)}},J=async()=>{R(!0);try{let e=await fetch("/api/alerts/distributors",{method:"POST"}),a=await e.json();e.ok&&(alert(`${a.message}`),U())}catch(e){console.error("Error generating alerts:",e)}finally{R(!1)}},K=async e=>{try{await fetch("/api/alerts/distributors",{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({alertId:e,action:"mark_read"})}),T(p.map(a=>a.id===e?{...a,is_read:!0}:a))}catch(e){console.error("Error marking as read:",e)}},V=async()=>{if(H){L(!0);try{(await fetch("/api/alerts/distributors",{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({alertId:H.id,action:"resolve",notes:q})})).ok&&(T(p.map(e=>e.id===H.id?{...e,is_resolved:!0,resolved_at:new Date().toISOString(),resolution_notes:q}:e)),Y(!1),$(null),F(""))}catch(e){console.error("Error resolving alert:",e)}finally{L(!1)}}};return(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[(0,a.jsxs)("div",{children:[(0,a.jsxs)("h2",{className:"text-2xl font-bold flex items-center gap-2",children:[(0,a.jsx)(v,{className:"w-6 h-6"}),"Alertas de Distribuidores"]}),(0,a.jsx)("p",{className:"text-muted-foreground",children:"Distribuidores que no han comprado recientemente"})]}),(0,a.jsxs)("div",{className:"flex gap-2",children:[e&&(0,a.jsxs)(M.Button,{variant:"outline",onClick:J,disabled:O,children:[O?(0,a.jsx)(j.RefreshCw,{className:"w-4 h-4 mr-2 animate-spin"}):(0,a.jsx)(v,{className:"w-4 h-4 mr-2"}),"Generar Alertas"]}),(0,a.jsxs)(M.Button,{variant:"outline",onClick:U,disabled:B,children:[(0,a.jsx)(j.RefreshCw,{className:`w-4 h-4 mr-2 ${B?"animate-spin":""}`}),"Actualizar"]})]})]}),(0,a.jsxs)("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[(0,a.jsx)(C.Card,{children:(0,a.jsx)(C.CardContent,{className:"pt-6",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-2xl font-bold",children:S.total}),(0,a.jsx)("p",{className:"text-sm text-muted-foreground",children:"Total alertas"})]}),(0,a.jsx)(v,{className:"w-8 h-8 text-muted-foreground"})]})})}),(0,a.jsx)(C.Card,{className:"border-amber-200 bg-amber-50",children:(0,a.jsx)(C.CardContent,{className:"pt-6",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-2xl font-bold text-amber-600",children:S.warning}),(0,a.jsx)("p",{className:"text-sm text-amber-700",children:"Advertencia"})]}),(0,a.jsx)(f.Clock,{className:"w-8 h-8 text-amber-500"})]})})}),(0,a.jsx)(C.Card,{className:"border-orange-200 bg-orange-50",children:(0,a.jsx)(C.CardContent,{className:"pt-6",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-2xl font-bold text-orange-600",children:S.critical}),(0,a.jsx)("p",{className:"text-sm text-orange-700",children:"Crítico"})]}),(0,a.jsx)(u.AlertTriangle,{className:"w-8 h-8 text-orange-500"})]})})}),(0,a.jsx)(C.Card,{className:"border-red-200 bg-red-50",children:(0,a.jsx)(C.CardContent,{className:"pt-6",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-2xl font-bold text-red-600",children:S.dormant}),(0,a.jsx)("p",{className:"text-sm text-red-700",children:"Dormido"})]}),(0,a.jsx)(x.AlertCircle,{className:"w-8 h-8 text-red-500"})]})})})]}),(0,a.jsx)(_.Tabs,{value:I,onValueChange:e=>X(e),children:(0,a.jsxs)(_.TabsList,{children:[(0,a.jsx)(_.TabsTrigger,{value:"unresolved",children:"Sin resolver"}),(0,a.jsx)(_.TabsTrigger,{value:"all",children:"Todas"})]})}),B?(0,a.jsxs)("div",{className:"text-center py-12",children:[(0,a.jsx)(j.RefreshCw,{className:"w-8 h-8 animate-spin mx-auto text-muted-foreground"}),(0,a.jsx)("p",{className:"mt-2 text-muted-foreground",children:"Cargando alertas..."})]}):0===p.length?(0,a.jsx)(C.Card,{children:(0,a.jsxs)(C.CardContent,{className:"py-12 text-center",children:[(0,a.jsx)(N,{className:"w-12 h-12 mx-auto text-muted-foreground mb-4"}),(0,a.jsx)("h3",{className:"text-lg font-medium",children:"No hay alertas"}),(0,a.jsx)("p",{className:"text-muted-foreground",children:"unresolved"===I?"Todas las alertas han sido resueltas":"No se han generado alertas aún"})]})}):(0,a.jsx)("div",{className:"space-y-4",children:p.map(e=>{var t,j,p;let v,N=(t=e.alert_type,(v={inactivity_warning:{icon:(0,a.jsx)(f.Clock,{className:"w-5 h-5"}),color:"text-amber-600",bgColor:"bg-amber-50 border-amber-200",label:"Advertencia (30+ días)"},inactivity_critical:{icon:(0,a.jsx)(u.AlertTriangle,{className:"w-5 h-5"}),color:"text-orange-600",bgColor:"bg-orange-50 border-orange-200",label:"Crítico (60+ días)"},inactivity_dormant:{icon:(0,a.jsx)(x.AlertCircle,{className:"w-5 h-5"}),color:"text-red-600",bgColor:"bg-red-50 border-red-200",label:"Dormido (90+ días)"}})[t]||v.inactivity_warning);return(0,a.jsx)(C.Card,{className:`${N.bgColor} ${!e.is_read?"ring-2 ring-primary":""} ${e.is_resolved?"opacity-60":""}`,children:(0,a.jsxs)(C.CardContent,{className:"py-4",children:[(0,a.jsxs)("div",{className:"flex items-start gap-4",children:[(0,a.jsx)("div",{className:N.color,children:N.icon}),(0,a.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,a.jsx)(w.Badge,{variant:"outline",className:N.color,children:N.label}),!e.is_read&&(0,a.jsx)(w.Badge,{variant:"default",className:"text-xs",children:"Nuevo"}),e.is_resolved&&(0,a.jsxs)(w.Badge,{variant:"secondary",className:"text-xs",children:[(0,a.jsx)(g.CheckCircle,{className:"w-3 h-3 mr-1"}),"Resuelto"]})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2 mb-2",children:[(0,a.jsx)(b.Building,{className:"w-4 h-4 text-muted-foreground"}),(0,a.jsx)("span",{className:"font-medium",children:e.distributor?.company_name})]}),(0,a.jsxs)("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"text-muted-foreground",children:"Días sin comprar:"}),(0,a.jsx)("p",{className:`font-bold ${N.color}`,children:e.days_since_purchase})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"text-muted-foreground",children:"Última compra:"}),(0,a.jsx)("p",{className:"font-medium",children:e.last_purchase_date?(0,s.format)(new Date(e.last_purchase_date),"dd/MM/yyyy"):"Nunca"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"text-muted-foreground",children:"Monto última:"}),(0,a.jsx)("p",{className:"font-medium",children:e.last_purchase_amount?`$${e.last_purchase_amount.toLocaleString()}`:"-"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"text-muted-foreground",children:"Corredor:"}),(0,a.jsx)("p",{className:"font-medium",children:e.agent?.user_profiles?.full_name||"Sin asignar"})]})]}),e.resolution_notes&&(0,a.jsxs)("div",{className:"mt-3 p-2 bg-white/50 rounded text-sm",children:[(0,a.jsx)(y,{className:"w-3 h-3 inline mr-1"}),e.resolution_notes]})]}),(0,a.jsxs)("div",{className:"flex flex-col gap-2",children:[!e.is_read&&(0,a.jsx)(M.Button,{variant:"ghost",size:"sm",onClick:()=>K(e.id),children:"Marcar leída"}),!e.is_resolved&&(0,a.jsxs)(M.Button,{variant:"outline",size:"sm",onClick:()=>{$(e),Y(!0)},children:[(0,a.jsx)(g.CheckCircle,{className:"w-4 h-4 mr-1"}),"Resolver"]})]})]}),(0,a.jsxs)("div",{className:"mt-2 text-xs text-muted-foreground",children:["Creada ",(j=new Date(e.created_at),p={addSuffix:!0,locale:h.es},function(e,a,t){var s;let r,h=(0,l.getDefaultOptions)(),u=t?.locale??h.locale??i.defaultLocale,x=c(e,a);if(isNaN(x))throw RangeError("Invalid time value");let f=Object.assign({},t,{addSuffix:t?.addSuffix,comparison:x}),[g,j]=(0,o.normalizeDates)(t?.in,...x>0?[a,e]:[e,a]),p=(s=void 0,e=>{let a=(s?Math[s]:Math.trunc)(e);return 0===a?0:a})(((0,d.toDate)(j)-(0,d.toDate)(g))/1e3),v=Math.round((p-((0,n.getTimezoneOffsetInMilliseconds)(j)-(0,n.getTimezoneOffsetInMilliseconds)(g))/1e3)/60);if(v<2)if(t?.includeSeconds)if(p<5)return u.formatDistance("lessThanXSeconds",5,f);else if(p<10)return u.formatDistance("lessThanXSeconds",10,f);else if(p<20)return u.formatDistance("lessThanXSeconds",20,f);else if(p<40)return u.formatDistance("halfAMinute",0,f);else if(p<60)return u.formatDistance("lessThanXMinutes",1,f);else return u.formatDistance("xMinutes",1,f);else if(0===v)return u.formatDistance("lessThanXMinutes",1,f);else return u.formatDistance("xMinutes",v,f);if(v<45)return u.formatDistance("xMinutes",v,f);if(v<90)return u.formatDistance("aboutXHours",1,f);if(v<m.minutesInDay){let e=Math.round(v/60);return u.formatDistance("aboutXHours",e,f)}if(v<2520)return u.formatDistance("xDays",1,f);else if(v<m.minutesInMonth){let e=Math.round(v/m.minutesInDay);return u.formatDistance("xDays",e,f)}else if(v<2*m.minutesInMonth)return r=Math.round(v/m.minutesInMonth),u.formatDistance("aboutXMonths",r,f);if((r=function(e,a,t){var s,r;let i,l,n,m,[h,u,x]=(0,o.normalizeDates)(void 0,e,e,a),f=c(u,x),g=Math.abs(function(e,a,t){let[s,r]=(0,o.normalizeDates)(void 0,e,a);return 12*(s.getFullYear()-r.getFullYear())+(s.getMonth()-r.getMonth())}(u,x));if(g<1)return 0;1===u.getMonth()&&u.getDate()>27&&u.setDate(30),u.setMonth(u.getMonth()-f*g);let j=c(u,x)===-f;+(i=(0,d.toDate)(h,void 0),s=void 0,(l=(0,d.toDate)(i,s?.in)).setHours(23,59,59,999),l)==+(r=void 0,m=(n=(0,d.toDate)(i,r?.in)).getMonth(),n.setFullYear(n.getFullYear(),m+1,0),n.setHours(23,59,59,999),n)&&1===g&&1===c(h,x)&&(j=!1);let p=f*(g-j);return 0===p?0:p}(j,g))<12){let e=Math.round(v/m.minutesInMonth);return u.formatDistance("xMonths",e,f)}{let e=r%12,a=Math.trunc(r/12);return e<3?u.formatDistance("aboutXYears",a,f):e<9?u.formatDistance("overXYears",a,f):u.formatDistance("almostXYears",a+1,f)}}(j,(0,r.constructFrom)(j,Date.now()),p))]})]})},e.id)})}),(0,a.jsx)(k.Dialog,{open:E,onOpenChange:Y,children:(0,a.jsxs)(k.DialogContent,{children:[(0,a.jsxs)(k.DialogHeader,{children:[(0,a.jsx)(k.DialogTitle,{children:"Resolver Alerta"}),(0,a.jsx)(k.DialogDescription,{children:"Marca esta alerta como resuelta y agrega notas opcionales"})]}),H&&(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{className:"p-4 bg-muted rounded-lg",children:[(0,a.jsx)("p",{className:"font-medium",children:H.distributor?.company_name}),(0,a.jsxs)("p",{className:"text-sm text-muted-foreground",children:[H.days_since_purchase," días sin comprar"]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"text-sm font-medium",children:"Notas de resolución (opcional)"}),(0,a.jsx)(D.Textarea,{value:q,onChange:e=>F(e.target.value),placeholder:"Ej: Se contactó al cliente, visitará la próxima semana...",className:"mt-1",rows:3})]})]}),(0,a.jsxs)(k.DialogFooter,{children:[(0,a.jsx)(M.Button,{variant:"outline",onClick:()=>Y(!1),children:"Cancelar"}),(0,a.jsxs)(M.Button,{onClick:V,disabled:P,children:[P?(0,a.jsx)(j.RefreshCw,{className:"w-4 h-4 mr-2 animate-spin"}):(0,a.jsx)(g.CheckCircle,{className:"w-4 h-4 mr-2"}),"Resolver Alerta"]})]})]})})]})}e.s(["DistributorAlerts",()=>T],369168)}]);