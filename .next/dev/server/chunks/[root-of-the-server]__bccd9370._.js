module.exports = [
"[externals]/next/dist/compiled/next-server/app-route-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-route-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/@opentelemetry/api [external] (next/dist/compiled/@opentelemetry/api, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/@opentelemetry/api", () => require("next/dist/compiled/@opentelemetry/api"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/next-server/app-page-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-page-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/shared/lib/no-fallback-error.external.js [external] (next/dist/shared/lib/no-fallback-error.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/shared/lib/no-fallback-error.external.js", () => require("next/dist/shared/lib/no-fallback-error.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/child_process [external] (child_process, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("child_process", () => require("child_process"));

module.exports = mod;
}),
"[externals]/fs [external] (fs, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("fs", () => require("fs"));

module.exports = mod;
}),
"[externals]/https [external] (https, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("https", () => require("https"));

module.exports = mod;
}),
"[externals]/stream [external] (stream, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("stream", () => require("stream"));

module.exports = mod;
}),
"[externals]/os [external] (os, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("os", () => require("os"));

module.exports = mod;
}),
"[externals]/events [external] (events, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("events", () => require("events"));

module.exports = mod;
}),
"[externals]/process [external] (process, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("process", () => require("process"));

module.exports = mod;
}),
"[externals]/util [external] (util, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("util", () => require("util"));

module.exports = mod;
}),
"[externals]/path [external] (path, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("path", () => require("path"));

module.exports = mod;
}),
"[externals]/crypto [external] (crypto, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("crypto", () => require("crypto"));

module.exports = mod;
}),
"[externals]/querystring [external] (querystring, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("querystring", () => require("querystring"));

module.exports = mod;
}),
"[externals]/buffer [external] (buffer, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("buffer", () => require("buffer"));

module.exports = mod;
}),
"[externals]/http2 [external] (http2, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("http2", () => require("http2"));

module.exports = mod;
}),
"[externals]/zlib [external] (zlib, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("zlib", () => require("zlib"));

module.exports = mod;
}),
"[externals]/url [external] (url, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("url", () => require("url"));

module.exports = mod;
}),
"[project]/lib/supabase/server.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "createClient",
    ()=>createClient
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/node_modules/@supabase/ssr/dist/module/index.js [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$createServerClient$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/@supabase/ssr/dist/module/createServerClient.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$headers$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/headers.js [app-route] (ecmascript)");
;
;
async function createClient() {
    const cookieStore = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$headers$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["cookies"])();
    const supabaseUrl = process.env.SUPABASE_URL || ("TURBOPACK compile-time value", "https://hbzgndpouxhxbhngotru.supabase.co");
    const supabaseAnonKey = process.env.SUPABASE_ANON_KEY || ("TURBOPACK compile-time value", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhiemduZHBvdXhoeGJobmdvdHJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5MDMzMTMsImV4cCI6MjA4MTQ3OTMxM30.2VDdLjXPFfPVON0E3FeCUYGCzkGC_s6_WAdijnzHYr8");
    if ("TURBOPACK compile-time falsy", 0) //TURBOPACK unreachable
    ;
    const client = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$createServerClient$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServerClient"])(supabaseUrl, supabaseAnonKey, {
        cookies: {
            getAll () {
                return cookieStore.getAll();
            },
            setAll (cookiesToSet) {
                try {
                    cookiesToSet.forEach(({ name, value, options })=>cookieStore.set(name, value, options));
                } catch  {
                // The "setAll" method was called from a Server Component.
                // This can be ignored if you have proxy refreshing user sessions.
                }
            }
        },
        auth: {
            detectSessionInUrl: true,
            flowType: "pkce"
        },
        global: {
            headers: {
                "X-Client-Info": "mesanova-web-server@1.0.0"
            }
        }
    });
    return client;
}
}),
"[project]/app/api/admin/analytics/route.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "GET",
    ()=>GET
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/server.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$googleapis$2f$build$2f$src$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/googleapis/build/src/index.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/lib/supabase/server.ts [app-route] (ecmascript)");
;
;
;
function getPrivateKey() {
    return process.env.GOOGLE_PRIVATE_KEY?.replace(/\\n/g, "\n");
}
function getDateRange(preset) {
    const today = new Date();
    const endDate = today.toISOString().slice(0, 10);
    const start = new Date(today);
    if (preset === "7d") start.setDate(start.getDate() - 6);
    else if (preset === "30d") start.setDate(start.getDate() - 29);
    else if (preset === "90d") start.setDate(start.getDate() - 89);
    else start.setDate(start.getDate() - 29);
    const startDate = start.toISOString().slice(0, 10);
    return {
        startDate,
        endDate
    };
}
function requireEnv(name, value) {
    if (!value) {
        throw new Error(`Missing env var: ${name}`);
    }
    return value;
}
function parseIntSafe(value) {
    const n = Number.parseInt(value || "", 10);
    return Number.isFinite(n) ? n : 0;
}
function parseFloatSafe(value) {
    const n = Number.parseFloat(value || "");
    return Number.isFinite(n) ? n : 0;
}
async function GET(req) {
    try {
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createClient"])();
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: "No autenticado"
            }, {
                status: 401
            });
        }
        const { data: profile, error: profileError } = await supabase.from("user_profiles").select("role").eq("id", user.id).single();
        if (profileError) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: profileError.message
            }, {
                status: 500
            });
        }
        if (profile?.role !== "superadmin") {
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: "No autorizado"
            }, {
                status: 403
            });
        }
        const url = new URL(req.url);
        const preset = url.searchParams.get("preset");
        const { startDate, endDate } = getDateRange(preset);
        const propertyId = requireEnv("GA4_PROPERTY_ID", process.env.GA4_PROPERTY_ID);
        const email = requireEnv("GOOGLE_SERVICE_ACCOUNT_EMAIL", process.env.GOOGLE_SERVICE_ACCOUNT_EMAIL);
        const privateKey = requireEnv("GOOGLE_PRIVATE_KEY", getPrivateKey());
        const auth = new __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$googleapis$2f$build$2f$src$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["google"].auth.JWT({
            email,
            key: privateKey,
            scopes: [
                "https://www.googleapis.com/auth/analytics.readonly"
            ]
        });
        const analyticsdata = __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$googleapis$2f$build$2f$src$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["google"].analyticsdata({
            version: "v1beta",
            auth
        });
        const property = `properties/${propertyId}`;
        const [summaryRes, timeseriesRes, sourcesRes, pagesRes, eventsRes] = await Promise.all([
            analyticsdata.properties.runReport({
                property,
                requestBody: {
                    dateRanges: [
                        {
                            startDate,
                            endDate
                        }
                    ],
                    metrics: [
                        {
                            name: "sessions"
                        },
                        {
                            name: "totalUsers"
                        },
                        {
                            name: "conversions"
                        }
                    ]
                }
            }),
            analyticsdata.properties.runReport({
                property,
                requestBody: {
                    dateRanges: [
                        {
                            startDate,
                            endDate
                        }
                    ],
                    dimensions: [
                        {
                            name: "date"
                        }
                    ],
                    metrics: [
                        {
                            name: "sessions"
                        },
                        {
                            name: "totalUsers"
                        }
                    ],
                    orderBys: [
                        {
                            dimension: {
                                dimensionName: "date"
                            }
                        }
                    ],
                    limit: "200"
                }
            }),
            analyticsdata.properties.runReport({
                property,
                requestBody: {
                    dateRanges: [
                        {
                            startDate,
                            endDate
                        }
                    ],
                    dimensions: [
                        {
                            name: "sessionDefaultChannelGroup"
                        }
                    ],
                    metrics: [
                        {
                            name: "sessions"
                        }
                    ],
                    orderBys: [
                        {
                            metric: {
                                metricName: "sessions"
                            },
                            desc: true
                        }
                    ],
                    limit: "10"
                }
            }),
            analyticsdata.properties.runReport({
                property,
                requestBody: {
                    dateRanges: [
                        {
                            startDate,
                            endDate
                        }
                    ],
                    dimensions: [
                        {
                            name: "pagePath"
                        }
                    ],
                    metrics: [
                        {
                            name: "screenPageViews"
                        }
                    ],
                    orderBys: [
                        {
                            metric: {
                                metricName: "screenPageViews"
                            },
                            desc: true
                        }
                    ],
                    limit: "10"
                }
            }),
            analyticsdata.properties.runReport({
                property,
                requestBody: {
                    dateRanges: [
                        {
                            startDate,
                            endDate
                        }
                    ],
                    dimensions: [
                        {
                            name: "eventName"
                        }
                    ],
                    metrics: [
                        {
                            name: "eventCount"
                        }
                    ],
                    orderBys: [
                        {
                            metric: {
                                metricName: "eventCount"
                            },
                            desc: true
                        }
                    ],
                    limit: "10"
                }
            })
        ]);
        const summaryRow = summaryRes.data.rows?.[0];
        const sessions = parseIntSafe(summaryRow?.metricValues?.[0]?.value);
        const users = parseIntSafe(summaryRow?.metricValues?.[1]?.value);
        const conversions = parseIntSafe(summaryRow?.metricValues?.[2]?.value);
        const conversionRate = sessions > 0 ? conversions / sessions * 100 : 0;
        const conversionRateRounded = conversionRate.toFixed(4);
        const timeseries = (timeseriesRes.data.rows || []).map((r)=>{
            const dateRaw = r.dimensionValues?.[0]?.value || "";
            const day = dateRaw.length === 8 ? `${dateRaw.slice(6, 8)}/${dateRaw.slice(4, 6)}` : dateRaw;
            return {
                date: dateRaw,
                day,
                sessions: parseIntSafe(r.metricValues?.[0]?.value),
                users: parseIntSafe(r.metricValues?.[1]?.value)
            };
        });
        const sources = (sourcesRes.data.rows || []).map((r)=>({
                source: r.dimensionValues?.[0]?.value || "(not set)",
                sessions: parseIntSafe(r.metricValues?.[0]?.value)
            }));
        const topPages = (pagesRes.data.rows || []).map((r)=>({
                path: r.dimensionValues?.[0]?.value || "",
                views: parseIntSafe(r.metricValues?.[0]?.value)
            }));
        const topEvents = (eventsRes.data.rows || []).map((r)=>({
                name: r.dimensionValues?.[0]?.value || "",
                count: parseIntSafe(r.metricValues?.[0]?.value)
            }));
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            range: {
                startDate,
                endDate,
                preset: preset || "30d"
            },
            kpis: {
                sessions,
                users,
                conversions,
                conversionRate: parseFloatSafe(conversionRateRounded)
            },
            timeseries,
            sources,
            topPages,
            topEvents
        });
    } catch (e) {
        const message = e instanceof Error ? e.message : "Unknown error";
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: message
        }, {
            status: 500
        });
    }
}
}),
];

//# sourceMappingURL=%5Broot-of-the-server%5D__bccd9370._.js.map