{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 136, "column": 0}, "map": {"version":3,"sources":["file:///Users/jrbuenaventura/Windsurf/Mesanova/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from \"@supabase/ssr\"\nimport { cookies } from \"next/headers\"\n\nexport async function createClient() {\n  const cookieStore = await cookies()\n\n  const supabaseUrl = process.env.SUPABASE_URL || process.env.NEXT_PUBLIC_SUPABASE_URL\n  const supabaseAnonKey = process.env.SUPABASE_ANON_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY\n\n  if (!supabaseUrl || !supabaseAnonKey) {\n    throw new Error(\"Missing Supabase environment variables\")\n  }\n\n  const client = createServerClient(supabaseUrl, supabaseAnonKey, {\n    cookies: {\n      getAll() {\n        return cookieStore.getAll()\n      },\n      setAll(cookiesToSet) {\n        try {\n          cookiesToSet.forEach(({ name, value, options }) => cookieStore.set(name, value, options))\n        } catch {\n          // The \"setAll\" method was called from a Server Component.\n          // This can be ignored if you have proxy refreshing user sessions.\n        }\n      },\n    },\n    auth: {\n      detectSessionInUrl: true,\n      flowType: \"pkce\",\n    },\n    global: {\n      headers: {\n        \"X-Client-Info\": \"mesanova-web-server@1.0.0\",\n      },\n    },\n  })\n\n  return client\n}\n"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;;;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,4IAAO;IAEjC,MAAM,cAAc,QAAQ,GAAG,CAAC,YAAY;IAC5C,MAAM,kBAAkB,QAAQ,GAAG,CAAC,iBAAiB;IAErD;;IAIA,MAAM,SAAS,IAAA,iMAAkB,EAAC,aAAa,iBAAiB;QAC9D,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAAK,YAAY,GAAG,CAAC,MAAM,OAAO;gBAClF,EAAE,OAAM;gBACN,0DAA0D;gBAC1D,kEAAkE;gBACpE;YACF;QACF;QACA,MAAM;YACJ,oBAAoB;YACpB,UAAU;QACZ;QACA,QAAQ;YACN,SAAS;gBACP,iBAAiB;YACnB;QACF;IACF;IAEA,OAAO;AACT"}},
    {"offset": {"line": 181, "column": 0}, "map": {"version":3,"sources":["file:///Users/jrbuenaventura/Windsurf/Mesanova/app/api/admin/analytics/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\nimport { google } from \"googleapis\"\nimport { createClient } from \"@/lib/supabase/server\"\n\nfunction getPrivateKey() {\n  return process.env.GOOGLE_PRIVATE_KEY?.replace(/\\\\n/g, \"\\n\")\n}\n\nfunction getDateRange(preset: string | null) {\n  const today = new Date()\n  const endDate = today.toISOString().slice(0, 10)\n\n  const start = new Date(today)\n  if (preset === \"7d\") start.setDate(start.getDate() - 6)\n  else if (preset === \"30d\") start.setDate(start.getDate() - 29)\n  else if (preset === \"90d\") start.setDate(start.getDate() - 89)\n  else start.setDate(start.getDate() - 29)\n\n  const startDate = start.toISOString().slice(0, 10)\n  return { startDate, endDate }\n}\n\nfunction requireEnv(name: string, value: string | undefined) {\n  if (!value) {\n    throw new Error(`Missing env var: ${name}`)\n  }\n  return value\n}\n\nfunction parseIntSafe(value: string | null | undefined) {\n  const n = Number.parseInt(value || \"\", 10)\n  return Number.isFinite(n) ? n : 0\n}\n\nfunction parseFloatSafe(value: string | null | undefined) {\n  const n = Number.parseFloat(value || \"\")\n  return Number.isFinite(n) ? n : 0\n}\n\nexport async function GET(req: Request) {\n  try {\n    const supabase = await createClient()\n\n    const {\n      data: { user },\n    } = await supabase.auth.getUser()\n\n    if (!user) {\n      return NextResponse.json({ error: \"No autenticado\" }, { status: 401 })\n    }\n\n    const { data: profile, error: profileError } = await supabase\n      .from(\"user_profiles\")\n      .select(\"role\")\n      .eq(\"id\", user.id)\n      .single()\n\n    if (profileError) {\n      return NextResponse.json({ error: profileError.message }, { status: 500 })\n    }\n\n    if (profile?.role !== \"superadmin\") {\n      return NextResponse.json({ error: \"No autorizado\" }, { status: 403 })\n    }\n\n    const url = new URL(req.url)\n    const preset = url.searchParams.get(\"preset\")\n    const { startDate, endDate } = getDateRange(preset)\n\n    const propertyId = requireEnv(\"GA4_PROPERTY_ID\", process.env.GA4_PROPERTY_ID)\n    const email = requireEnv(\"GOOGLE_SERVICE_ACCOUNT_EMAIL\", process.env.GOOGLE_SERVICE_ACCOUNT_EMAIL)\n    const privateKey = requireEnv(\"GOOGLE_PRIVATE_KEY\", getPrivateKey())\n\n    const auth = new google.auth.JWT({\n      email,\n      key: privateKey,\n      scopes: [\"https://www.googleapis.com/auth/analytics.readonly\"],\n    })\n\n    const analyticsdata = google.analyticsdata({ version: \"v1beta\", auth })\n    const property = `properties/${propertyId}`\n\n    const [summaryRes, timeseriesRes, sourcesRes, pagesRes, eventsRes] = await Promise.all([\n      analyticsdata.properties.runReport({\n        property,\n        requestBody: {\n          dateRanges: [{ startDate, endDate }],\n          metrics: [{ name: \"sessions\" }, { name: \"totalUsers\" }, { name: \"conversions\" }],\n        },\n      } as any),\n      analyticsdata.properties.runReport({\n        property,\n        requestBody: {\n          dateRanges: [{ startDate, endDate }],\n          dimensions: [{ name: \"date\" }],\n          metrics: [{ name: \"sessions\" }, { name: \"totalUsers\" }],\n          orderBys: [{ dimension: { dimensionName: \"date\" } }],\n          limit: \"200\",\n        },\n      } as any),\n      analyticsdata.properties.runReport({\n        property,\n        requestBody: {\n          dateRanges: [{ startDate, endDate }],\n          dimensions: [{ name: \"sessionDefaultChannelGroup\" }],\n          metrics: [{ name: \"sessions\" }],\n          orderBys: [{ metric: { metricName: \"sessions\" }, desc: true }],\n          limit: \"10\",\n        },\n      } as any),\n      analyticsdata.properties.runReport({\n        property,\n        requestBody: {\n          dateRanges: [{ startDate, endDate }],\n          dimensions: [{ name: \"pagePath\" }],\n          metrics: [{ name: \"screenPageViews\" }],\n          orderBys: [{ metric: { metricName: \"screenPageViews\" }, desc: true }],\n          limit: \"10\",\n        },\n      } as any),\n      analyticsdata.properties.runReport({\n        property,\n        requestBody: {\n          dateRanges: [{ startDate, endDate }],\n          dimensions: [{ name: \"eventName\" }],\n          metrics: [{ name: \"eventCount\" }],\n          orderBys: [{ metric: { metricName: \"eventCount\" }, desc: true }],\n          limit: \"10\",\n        },\n      } as any),\n    ])\n\n    const summaryRow = summaryRes.data.rows?.[0]\n    const sessions = parseIntSafe(summaryRow?.metricValues?.[0]?.value)\n    const users = parseIntSafe(summaryRow?.metricValues?.[1]?.value)\n    const conversions = parseIntSafe(summaryRow?.metricValues?.[2]?.value)\n    const conversionRate = sessions > 0 ? (conversions / sessions) * 100 : 0\n    const conversionRateRounded = conversionRate.toFixed(4)\n\n    const timeseries = (timeseriesRes.data.rows || []).map((r) => {\n      const dateRaw = r.dimensionValues?.[0]?.value || \"\"\n      const day = dateRaw.length === 8 ? `${dateRaw.slice(6, 8)}/${dateRaw.slice(4, 6)}` : dateRaw\n      return {\n        date: dateRaw,\n        day,\n        sessions: parseIntSafe(r.metricValues?.[0]?.value),\n        users: parseIntSafe(r.metricValues?.[1]?.value),\n      }\n    })\n\n    const sources = (sourcesRes.data.rows || []).map((r) => ({\n      source: r.dimensionValues?.[0]?.value || \"(not set)\",\n      sessions: parseIntSafe(r.metricValues?.[0]?.value),\n    }))\n\n    const topPages = (pagesRes.data.rows || []).map((r) => ({\n      path: r.dimensionValues?.[0]?.value || \"\",\n      views: parseIntSafe(r.metricValues?.[0]?.value),\n    }))\n\n    const topEvents = (eventsRes.data.rows || []).map((r) => ({\n      name: r.dimensionValues?.[0]?.value || \"\",\n      count: parseIntSafe(r.metricValues?.[0]?.value),\n    }))\n\n    return NextResponse.json({\n      range: { startDate, endDate, preset: preset || \"30d\" },\n      kpis: { sessions, users, conversions, conversionRate: parseFloatSafe(conversionRateRounded) },\n      timeseries,\n      sources,\n      topPages,\n      topEvents,\n    })\n  } catch (e) {\n    const message = e instanceof Error ? e.message : \"Unknown error\"\n    return NextResponse.json({ error: message }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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"}}]
}