{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/jrbuenaventura/Windsurf/Mesanova/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from \"@supabase/ssr\"\nimport { cookies } from \"next/headers\"\n\nexport async function createClient() {\n  const cookieStore = await cookies()\n\n  const supabaseUrl = process.env.SUPABASE_URL || process.env.NEXT_PUBLIC_SUPABASE_URL\n  const supabaseAnonKey = process.env.SUPABASE_ANON_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY\n\n  if (!supabaseUrl || !supabaseAnonKey) {\n    throw new Error(\"Missing Supabase environment variables\")\n  }\n\n  const client = createServerClient(supabaseUrl, supabaseAnonKey, {\n    cookies: {\n      getAll() {\n        return cookieStore.getAll()\n      },\n      setAll(cookiesToSet) {\n        try {\n          cookiesToSet.forEach(({ name, value, options }) => cookieStore.set(name, value, options))\n        } catch {\n          // The \"setAll\" method was called from a Server Component.\n          // This can be ignored if you have proxy refreshing user sessions.\n        }\n      },\n    },\n    auth: {\n      detectSessionInUrl: true,\n      flowType: \"pkce\",\n    },\n    global: {\n      headers: {\n        \"X-Client-Info\": \"mesanova-web-server@1.0.0\",\n      },\n    },\n  })\n\n  return client\n}\n"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;;;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,4IAAO;IAEjC,MAAM,cAAc,QAAQ,GAAG,CAAC,YAAY;IAC5C,MAAM,kBAAkB,QAAQ,GAAG,CAAC,iBAAiB;IAErD;;IAIA,MAAM,SAAS,IAAA,iMAAkB,EAAC,aAAa,iBAAiB;QAC9D,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAAK,YAAY,GAAG,CAAC,MAAM,OAAO;gBAClF,EAAE,OAAM;gBACN,0DAA0D;gBAC1D,kEAAkE;gBACpE;YACF;QACF;QACA,MAAM;YACJ,oBAAoB;YACpB,UAAU;QACZ;QACA,QAAQ;YACN,SAAS;gBACP,iBAAiB;YACnB;QACF;IACF;IAEA,OAAO;AACT"}},
    {"offset": {"line": 91, "column": 0}, "map": {"version":3,"sources":["file:///Users/jrbuenaventura/Windsurf/Mesanova/lib/csv/product-template.ts"],"sourcesContent":["// Definición del template CSV para productos\n// Los campos están ordenados según la especificación del usuario\n\nexport interface ProductCSVRow {\n  // Campos de identificación\n  Ref: string;\n  Cod_Barra: string;\n  Producto: string;\n  Descripcion: string;\n  Marca: string;\n  \n  // Precios y ofertas\n  Precio_COP: string;\n  Descuento: string; // Porcentaje (0-100)\n  \n  // Inventario\n  Existencia_inv: string;\n  Pedido_en_camino: string; // SI/NO\n  Descontinuado: string; // SI/NO\n  \n  // Empaque\n  Inner_pack: string;\n  Outer_pack: string;\n  \n  // Categorización\n  Coleccion: string;\n  Categoria: string; // Silo principal\n  Subcategoria: string;\n  Tipo_producto: string;\n  \n  // Características físicas\n  Material: string;\n  Color: string;\n  Dimensiones: string;\n  Peso_kg: string;\n  Capacidad: string;\n  Pais_origen: string;\n  \n  // Contenido para cliente final\n  Descrip_Cliente_Final: string;\n  Momentos_Uso_Cliente: string;\n  Productos_Afines_Cliente: string; // Referencias separadas por coma\n  \n  // Contenido para distribuidor/canal\n  Descrip_Distribuidor: string;\n  Argumentos_Venta_Distribuidor: string;\n  Ubicacion_Tienda_Distribuidor: string;\n  Margen_Sugerido: string; // Porcentaje\n  Rotacion_Esperada: string; // alta/media/baja\n  \n  // SEO\n  SEO_Title: string;\n  SEO_Description: string;\n  Tags: string; // Separadas por coma\n  \n  // Multimedia\n  Video_URL: string;\n  Ficha_Tecnica_URL: string;\n  Fecha_Lanzamiento: string; // YYYY-MM-DD\n  \n  // Imágenes (URLs)\n  Image_1: string;\n  Image_2: string;\n  Image_3: string;\n  Image_4: string;\n  Image_5: string;\n  Image_6: string;\n  Image_7: string;\n  Image_8: string;\n  Image_9: string;\n  Image_10: string;\n}\n\nexport const CSV_HEADERS: (keyof ProductCSVRow)[] = [\n  'Ref',\n  'Cod_Barra',\n  'Producto',\n  'Descripcion',\n  'Marca',\n  'Precio_COP',\n  'Descuento',\n  'Existencia_inv',\n  'Pedido_en_camino',\n  'Descontinuado',\n  'Inner_pack',\n  'Outer_pack',\n  'Coleccion',\n  'Categoria',\n  'Subcategoria',\n  'Tipo_producto',\n  'Material',\n  'Color',\n  'Dimensiones',\n  'Peso_kg',\n  'Capacidad',\n  'Pais_origen',\n  'Descrip_Cliente_Final',\n  'Momentos_Uso_Cliente',\n  'Productos_Afines_Cliente',\n  'Descrip_Distribuidor',\n  'Argumentos_Venta_Distribuidor',\n  'Ubicacion_Tienda_Distribuidor',\n  'Margen_Sugerido',\n  'Rotacion_Esperada',\n  'SEO_Title',\n  'SEO_Description',\n  'Tags',\n  'Video_URL',\n  'Ficha_Tecnica_URL',\n  'Fecha_Lanzamiento',\n  'Image_1',\n  'Image_2',\n  'Image_3',\n  'Image_4',\n  'Image_5',\n  'Image_6',\n  'Image_7',\n  'Image_8',\n  'Image_9',\n  'Image_10',\n];\n\nexport const CSV_HEADER_DESCRIPTIONS: Record<keyof ProductCSVRow, string> = {\n  Ref: 'Código de referencia único del producto (obligatorio)',\n  Cod_Barra: 'Código de barras EAN/UPC',\n  Producto: 'Nombre comercial del producto (obligatorio)',\n  Descripcion: 'Descripción corta o subtítulo',\n  Marca: 'Marca del producto',\n  Precio_COP: 'Precio base en pesos colombianos (obligatorio)',\n  Descuento: 'Porcentaje de descuento (0-100). Si > 0, aparece en ofertas',\n  Existencia_inv: 'Cantidad en inventario',\n  Pedido_en_camino: 'SI/NO - Indica si hay pedido en tránsito',\n  Descontinuado: 'SI/NO - Producto que no se volverá a pedir',\n  Inner_pack: 'Empaque primario (unidades por empaque)',\n  Outer_pack: 'Empaque secundario (empaques primarios por caja)',\n  Coleccion: 'Nombre de la colección a la que pertenece',\n  Categoria: 'Categoría principal (Cocina, Mesa, Café-Té-Bar, Termos-Neveras, Profesional)',\n  Subcategoria: 'Subcategoría dentro de la categoría principal',\n  Tipo_producto: 'Tipo específico de producto (3er nivel)',\n  Material: 'Material principal del producto',\n  Color: 'Color del producto',\n  Dimensiones: 'Dimensiones del producto (ej: 30x20x10 cm)',\n  Peso_kg: 'Peso en kilogramos',\n  Capacidad: 'Capacidad si aplica (ej: 500ml)',\n  Pais_origen: 'País de origen del producto',\n  Descrip_Cliente_Final: 'Descripción amplia para cliente final',\n  Momentos_Uso_Cliente: 'Momentos de uso sugeridos para cliente final',\n  Productos_Afines_Cliente: 'Referencias de productos afines separadas por coma',\n  Descrip_Distribuidor: 'Descripción visible solo para distribuidores y canal',\n  Argumentos_Venta_Distribuidor: 'Argumentos de venta para distribuidores',\n  Ubicacion_Tienda_Distribuidor: 'Sugerencia de ubicación en tienda del distribuidor',\n  Margen_Sugerido: 'Margen de ganancia sugerido para distribuidor (%)',\n  Rotacion_Esperada: 'Rotación esperada: alta, media o baja',\n  SEO_Title: 'Título SEO para buscadores',\n  SEO_Description: 'Descripción SEO para buscadores',\n  Tags: 'Etiquetas de búsqueda separadas por coma',\n  Video_URL: 'URL del video del producto',\n  Ficha_Tecnica_URL: 'URL del PDF de ficha técnica',\n  Fecha_Lanzamiento: 'Fecha de lanzamiento (YYYY-MM-DD)',\n  Image_1: 'URL de imagen principal (obligatoria)',\n  Image_2: 'URL de imagen 2',\n  Image_3: 'URL de imagen 3',\n  Image_4: 'URL de imagen 4',\n  Image_5: 'URL de imagen 5',\n  Image_6: 'URL de imagen 6',\n  Image_7: 'URL de imagen 7',\n  Image_8: 'URL de imagen 8',\n  Image_9: 'URL de imagen 9',\n  Image_10: 'URL de imagen 10',\n};\n\nexport const REQUIRED_FIELDS: (keyof ProductCSVRow)[] = [\n  'Ref',\n  'Producto',\n  'Precio_COP',\n];\n\nexport const BOOLEAN_FIELDS: (keyof ProductCSVRow)[] = [\n  'Pedido_en_camino',\n  'Descontinuado',\n];\n\nexport const NUMERIC_FIELDS: (keyof ProductCSVRow)[] = [\n  'Precio_COP',\n  'Descuento',\n  'Existencia_inv',\n  'Peso_kg',\n  'Margen_Sugerido',\n];\n\nexport const VALID_CATEGORIES = [\n  'Cocina',\n  'Mesa',\n  'Café-Té-Bar',\n  'Termos-Neveras',\n  'Profesional',\n];\n\nexport const VALID_ROTACION = ['alta', 'media', 'baja'];\n\nexport function generateEmptyCSVTemplate(): string {\n  return CSV_HEADERS.join(',');\n}\n\nexport function generateCSVWithDescriptions(): string {\n  const headerRow = CSV_HEADERS.join(',');\n  const descriptionRow = CSV_HEADERS.map(h => `\"${CSV_HEADER_DESCRIPTIONS[h]}\"`).join(',');\n  const exampleRow = generateExampleRow();\n  \n  return `${headerRow}\\n${descriptionRow}\\n${exampleRow}`;\n}\n\nfunction generateExampleRow(): string {\n  const example: Partial<ProductCSVRow> = {\n    Ref: 'ABC-001',\n    Cod_Barra: '7701234567890',\n    Producto: 'Tabla de Cortar Bambú Premium',\n    Descripcion: 'Tabla de cortar profesional en bambú ecológico',\n    Marca: 'Mesa Nova',\n    Precio_COP: '89900',\n    Descuento: '15',\n    Existencia_inv: '150',\n    Pedido_en_camino: 'NO',\n    Descontinuado: 'NO',\n    Inner_pack: '1',\n    Outer_pack: '12',\n    Coleccion: 'Eco Kitchen',\n    Categoria: 'Cocina',\n    Subcategoria: 'Corte y Picado',\n    Tipo_producto: 'Tablas de Cortar',\n    Material: 'Bambú',\n    Color: 'Natural',\n    Dimensiones: '40x30x2 cm',\n    Peso_kg: '0.8',\n    Capacidad: '',\n    Pais_origen: 'China',\n    Descrip_Cliente_Final: 'Tabla de cortar elaborada en bambú 100% natural...',\n    Momentos_Uso_Cliente: 'Ideal para preparar tus comidas diarias...',\n    Productos_Afines_Cliente: 'ABC-002,ABC-003',\n    Descrip_Distribuidor: 'Producto de alta rotación con excelente margen...',\n    Argumentos_Venta_Distribuidor: 'Material ecológico muy demandado...',\n    Ubicacion_Tienda_Distribuidor: 'Zona de cocina cerca de cuchillos',\n    Margen_Sugerido: '40',\n    Rotacion_Esperada: 'alta',\n    SEO_Title: 'Tabla de Cortar Bambú | Mesa Nova',\n    SEO_Description: 'Compra tabla de cortar en bambú ecológico...',\n    Tags: 'tabla,cortar,bambú,cocina,ecológico',\n    Video_URL: 'https://youtube.com/watch?v=xxx',\n    Ficha_Tecnica_URL: 'https://cdn.mesanova.com/fichas/abc-001.pdf',\n    Fecha_Lanzamiento: '2026-01-15',\n    Image_1: 'https://cdn.mesanova.com/products/abc-001-1.jpg',\n    Image_2: 'https://cdn.mesanova.com/products/abc-001-2.jpg',\n    Image_3: '',\n    Image_4: '',\n    Image_5: '',\n    Image_6: '',\n    Image_7: '',\n    Image_8: '',\n    Image_9: '',\n    Image_10: '',\n  };\n  \n  return CSV_HEADERS.map(h => {\n    const value = example[h] || '';\n    return value.includes(',') || value.includes('\"') ? `\"${value.replace(/\"/g, '\"\"')}\"` : value;\n  }).join(',');\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 304, "column": 0}, "map": {"version":3,"sources":["file:///Users/jrbuenaventura/Windsurf/Mesanova/lib/csv/product-parser.ts"],"sourcesContent":["import {\n  ProductCSVRow,\n  CSV_HEADERS,\n  REQUIRED_FIELDS,\n  BOOLEAN_FIELDS,\n  NUMERIC_FIELDS,\n  VALID_CATEGORIES,\n  VALID_ROTACION,\n} from './product-template';\n\nexport interface ParsedProduct {\n  row: number;\n  data: ProductCSVRow;\n  errors: ValidationError[];\n  warnings: ValidationWarning[];\n  isValid: boolean;\n}\n\nexport interface ValidationError {\n  field: keyof ProductCSVRow;\n  message: string;\n  value: string;\n}\n\nexport interface ValidationWarning {\n  field: keyof ProductCSVRow;\n  message: string;\n  value: string;\n}\n\nexport interface CSVParseResult {\n  success: boolean;\n  totalRows: number;\n  validRows: number;\n  invalidRows: number;\n  products: ParsedProduct[];\n  globalErrors: string[];\n}\n\nexport interface ProductChange {\n  field: string;\n  oldValue: string | null;\n  newValue: string | null;\n}\n\nexport interface ProductDiff {\n  ref: string;\n  changeType: 'create' | 'update' | 'unchanged';\n  changes: ProductChange[];\n}\n\nfunction parseCSVLine(line: string): string[] {\n  const result: string[] = [];\n  let current = '';\n  let inQuotes = false;\n  \n  for (let i = 0; i < line.length; i++) {\n    const char = line[i];\n    const nextChar = line[i + 1];\n    \n    if (char === '\"') {\n      if (inQuotes && nextChar === '\"') {\n        current += '\"';\n        i++;\n      } else {\n        inQuotes = !inQuotes;\n      }\n    } else if (char === ',' && !inQuotes) {\n      result.push(current.trim());\n      current = '';\n    } else {\n      current += char;\n    }\n  }\n  \n  result.push(current.trim());\n  return result;\n}\n\nfunction validateRow(row: ProductCSVRow, rowNumber: number): { errors: ValidationError[]; warnings: ValidationWarning[] } {\n  const errors: ValidationError[] = [];\n  const warnings: ValidationWarning[] = [];\n  \n  // Validar campos requeridos\n  for (const field of REQUIRED_FIELDS) {\n    if (!row[field] || row[field].trim() === '') {\n      errors.push({\n        field,\n        message: `El campo ${field} es obligatorio`,\n        value: row[field] || '',\n      });\n    }\n  }\n  \n  // Validar campos numéricos\n  for (const field of NUMERIC_FIELDS) {\n    const value = row[field];\n    if (value && value.trim() !== '') {\n      const numValue = parseFloat(value.replace(/[,$]/g, ''));\n      if (isNaN(numValue)) {\n        errors.push({\n          field,\n          message: `El campo ${field} debe ser un número válido`,\n          value,\n        });\n      } else if (numValue < 0) {\n        errors.push({\n          field,\n          message: `El campo ${field} no puede ser negativo`,\n          value,\n        });\n      }\n    }\n  }\n  \n  // Validar campos booleanos\n  for (const field of BOOLEAN_FIELDS) {\n    const value = row[field]?.toUpperCase();\n    if (value && value !== '' && value !== 'SI' && value !== 'NO' && value !== 'TRUE' && value !== 'FALSE' && value !== '1' && value !== '0') {\n      errors.push({\n        field,\n        message: `El campo ${field} debe ser SI/NO`,\n        value: row[field],\n      });\n    }\n  }\n  \n  // Validar categoría\n  if (row.Categoria && row.Categoria.trim() !== '') {\n    const normalizedCat = row.Categoria.trim();\n    if (!VALID_CATEGORIES.some(c => c.toLowerCase() === normalizedCat.toLowerCase())) {\n      warnings.push({\n        field: 'Categoria',\n        message: `Categoría \"${normalizedCat}\" no reconocida. Válidas: ${VALID_CATEGORIES.join(', ')}`,\n        value: row.Categoria,\n      });\n    }\n  }\n  \n  // Validar rotación esperada\n  if (row.Rotacion_Esperada && row.Rotacion_Esperada.trim() !== '') {\n    const rotacion = row.Rotacion_Esperada.toLowerCase().trim();\n    if (!VALID_ROTACION.includes(rotacion)) {\n      errors.push({\n        field: 'Rotacion_Esperada',\n        message: `Rotación debe ser: ${VALID_ROTACION.join(', ')}`,\n        value: row.Rotacion_Esperada,\n      });\n    }\n  }\n  \n  // Validar descuento (0-100)\n  if (row.Descuento && row.Descuento.trim() !== '') {\n    const descuento = parseFloat(row.Descuento);\n    if (!isNaN(descuento) && (descuento < 0 || descuento > 100)) {\n      errors.push({\n        field: 'Descuento',\n        message: 'El descuento debe estar entre 0 y 100',\n        value: row.Descuento,\n      });\n    }\n  }\n  \n  // Validar margen sugerido (0-100)\n  if (row.Margen_Sugerido && row.Margen_Sugerido.trim() !== '') {\n    const margen = parseFloat(row.Margen_Sugerido);\n    if (!isNaN(margen) && (margen < 0 || margen > 100)) {\n      warnings.push({\n        field: 'Margen_Sugerido',\n        message: 'El margen sugerido parece fuera de rango normal (0-100%)',\n        value: row.Margen_Sugerido,\n      });\n    }\n  }\n  \n  // Validar fecha de lanzamiento\n  if (row.Fecha_Lanzamiento && row.Fecha_Lanzamiento.trim() !== '') {\n    const dateRegex = /^\\d{4}-\\d{2}-\\d{2}$/;\n    if (!dateRegex.test(row.Fecha_Lanzamiento)) {\n      errors.push({\n        field: 'Fecha_Lanzamiento',\n        message: 'La fecha debe tener formato YYYY-MM-DD',\n        value: row.Fecha_Lanzamiento,\n      });\n    } else {\n      const date = new Date(row.Fecha_Lanzamiento);\n      if (isNaN(date.getTime())) {\n        errors.push({\n          field: 'Fecha_Lanzamiento',\n          message: 'Fecha inválida',\n          value: row.Fecha_Lanzamiento,\n        });\n      }\n    }\n  }\n  \n  // Validar URLs de imágenes\n  const imageFields: (keyof ProductCSVRow)[] = [\n    'Image_1', 'Image_2', 'Image_3', 'Image_4', 'Image_5',\n    'Image_6', 'Image_7', 'Image_8', 'Image_9', 'Image_10',\n  ];\n  \n  for (const field of imageFields) {\n    const value = row[field];\n    if (value && value.trim() !== '') {\n      try {\n        new URL(value);\n      } catch {\n        errors.push({\n          field,\n          message: 'URL de imagen inválida',\n          value,\n        });\n      }\n    }\n  }\n  \n  // Validar Video URL\n  if (row.Video_URL && row.Video_URL.trim() !== '') {\n    try {\n      new URL(row.Video_URL);\n    } catch {\n      errors.push({\n        field: 'Video_URL',\n        message: 'URL de video inválida',\n        value: row.Video_URL,\n      });\n    }\n  }\n  \n  // Validar Ficha Técnica URL\n  if (row.Ficha_Tecnica_URL && row.Ficha_Tecnica_URL.trim() !== '') {\n    try {\n      new URL(row.Ficha_Tecnica_URL);\n    } catch {\n      errors.push({\n        field: 'Ficha_Tecnica_URL',\n        message: 'URL de ficha técnica inválida',\n        value: row.Ficha_Tecnica_URL,\n      });\n    }\n  }\n  \n  // Warning si no hay imagen principal\n  if (!row.Image_1 || row.Image_1.trim() === '') {\n    warnings.push({\n      field: 'Image_1',\n      message: 'Se recomienda incluir al menos una imagen',\n      value: '',\n    });\n  }\n  \n  return { errors, warnings };\n}\n\nexport function parseCSV(csvContent: string): CSVParseResult {\n  const lines = csvContent.split(/\\r?\\n/).filter(line => line.trim() !== '');\n  const globalErrors: string[] = [];\n  const products: ParsedProduct[] = [];\n  \n  if (lines.length === 0) {\n    return {\n      success: false,\n      totalRows: 0,\n      validRows: 0,\n      invalidRows: 0,\n      products: [],\n      globalErrors: ['El archivo está vacío'],\n    };\n  }\n  \n  // Parsear headers\n  const headerLine = lines[0];\n  const headers = parseCSVLine(headerLine);\n  \n  // Verificar que los headers coincidan\n  const missingHeaders = CSV_HEADERS.filter(h => !headers.includes(h));\n  const extraHeaders = headers.filter(h => !CSV_HEADERS.includes(h as keyof ProductCSVRow));\n  \n  if (missingHeaders.length > 0) {\n    globalErrors.push(`Columnas faltantes: ${missingHeaders.join(', ')}`);\n  }\n  \n  if (extraHeaders.length > 0) {\n    globalErrors.push(`Columnas no reconocidas (serán ignoradas): ${extraHeaders.join(', ')}`);\n  }\n  \n  // Crear mapa de índices\n  const headerIndexMap: Record<string, number> = {};\n  headers.forEach((h, i) => {\n    headerIndexMap[h] = i;\n  });\n  \n  // Saltar la primera fila si parece ser descripción (contiene texto largo)\n  let startRow = 1;\n  if (lines.length > 1) {\n    const secondLine = parseCSVLine(lines[1]);\n    const firstValue = secondLine[0] || '';\n    // Si el primer valor de la segunda fila tiene más de 50 caracteres, probablemente es descripción\n    if (firstValue.length > 50 || firstValue.toLowerCase().includes('obligatorio')) {\n      startRow = 2;\n    }\n  }\n  \n  // Parsear filas de datos\n  for (let i = startRow; i < lines.length; i++) {\n    const line = lines[i];\n    if (line.trim() === '') continue;\n    \n    const values = parseCSVLine(line);\n    \n    // Crear objeto ProductCSVRow\n    const rowData: ProductCSVRow = {} as ProductCSVRow;\n    for (const header of CSV_HEADERS) {\n      const index = headerIndexMap[header];\n      rowData[header] = index !== undefined ? (values[index] || '') : '';\n    }\n    \n    // Validar\n    const { errors, warnings } = validateRow(rowData, i + 1);\n    \n    products.push({\n      row: i + 1,\n      data: rowData,\n      errors,\n      warnings,\n      isValid: errors.length === 0,\n    });\n  }\n  \n  const validRows = products.filter(p => p.isValid).length;\n  const invalidRows = products.filter(p => !p.isValid).length;\n  \n  return {\n    success: invalidRows === 0 && globalErrors.length === 0,\n    totalRows: products.length,\n    validRows,\n    invalidRows,\n    products,\n    globalErrors,\n  };\n}\n\nexport function compareWithExisting(\n  newProducts: ParsedProduct[],\n  existingProducts: Map<string, Record<string, unknown>>\n): ProductDiff[] {\n  const diffs: ProductDiff[] = [];\n  \n  for (const newProduct of newProducts) {\n    if (!newProduct.isValid) continue;\n    \n    const ref = newProduct.data.Ref;\n    const existing = existingProducts.get(ref);\n    \n    if (!existing) {\n      // Producto nuevo\n      diffs.push({\n        ref,\n        changeType: 'create',\n        changes: [],\n      });\n    } else {\n      // Comparar campos\n      const changes: ProductChange[] = [];\n      \n      const fieldMappings: Record<keyof ProductCSVRow, string> = {\n        Ref: 'pdt_codigo',\n        Cod_Barra: 'codigo_barras',\n        Producto: 'nombre_comercial',\n        Descripcion: 'pdt_descripcion',\n        Marca: 'marca',\n        Precio_COP: 'precio',\n        Descuento: 'descuento_porcentaje',\n        Existencia_inv: 'upp_existencia',\n        Pedido_en_camino: 'pedido_en_camino',\n        Descontinuado: 'descontinuado',\n        Inner_pack: 'pdt_empaque',\n        Outer_pack: 'outer_pack',\n        Coleccion: 'nombre_coleccion',\n        Categoria: '_category', // Handled separately\n        Subcategoria: '_subcategory',\n        Tipo_producto: '_type',\n        Material: 'material',\n        Color: 'color',\n        Dimensiones: 'dimensiones',\n        Peso_kg: 'peso',\n        Capacidad: 'capacidad',\n        Pais_origen: 'pais_origen',\n        Descrip_Cliente_Final: 'descripcion_larga',\n        Momentos_Uso_Cliente: 'momentos_uso',\n        Productos_Afines_Cliente: 'productos_afines_csv',\n        Descrip_Distribuidor: 'descripcion_distribuidor',\n        Argumentos_Venta_Distribuidor: 'argumentos_venta',\n        Ubicacion_Tienda_Distribuidor: 'ubicacion_tienda',\n        Margen_Sugerido: 'margen_sugerido',\n        Rotacion_Esperada: 'rotacion_esperada',\n        SEO_Title: 'seo_title',\n        SEO_Description: 'seo_description',\n        Tags: 'tags',\n        Video_URL: 'video_url',\n        Ficha_Tecnica_URL: 'ficha_tecnica_url',\n        Fecha_Lanzamiento: 'fecha_lanzamiento',\n        Image_1: 'imagen_principal_url',\n        Image_2: '_image_2',\n        Image_3: '_image_3',\n        Image_4: '_image_4',\n        Image_5: '_image_5',\n        Image_6: '_image_6',\n        Image_7: '_image_7',\n        Image_8: '_image_8',\n        Image_9: '_image_9',\n        Image_10: '_image_10',\n      };\n      \n      for (const [csvField, dbField] of Object.entries(fieldMappings)) {\n        if (dbField.startsWith('_')) continue; // Skip special fields\n        \n        const newValue = newProduct.data[csvField as keyof ProductCSVRow] || '';\n        const oldValue = String(existing[dbField] || '');\n        \n        // Normalize values for comparison\n        const normalizedNew = normalizeValue(newValue, csvField as keyof ProductCSVRow);\n        const normalizedOld = normalizeValue(oldValue, csvField as keyof ProductCSVRow);\n        \n        if (normalizedNew !== normalizedOld) {\n          changes.push({\n            field: csvField,\n            oldValue: oldValue || null,\n            newValue: newValue || null,\n          });\n        }\n      }\n      \n      if (changes.length > 0) {\n        diffs.push({\n          ref,\n          changeType: 'update',\n          changes,\n        });\n      } else {\n        diffs.push({\n          ref,\n          changeType: 'unchanged',\n          changes: [],\n        });\n      }\n    }\n  }\n  \n  return diffs;\n}\n\nfunction normalizeValue(value: string, field: keyof ProductCSVRow): string {\n  if (!value) return '';\n  \n  // Para booleanos\n  if (BOOLEAN_FIELDS.includes(field)) {\n    const upper = value.toUpperCase();\n    if (upper === 'SI' || upper === 'TRUE' || upper === '1') return 'true';\n    if (upper === 'NO' || upper === 'FALSE' || upper === '0') return 'false';\n    return value.toLowerCase();\n  }\n  \n  // Para numéricos\n  if (NUMERIC_FIELDS.includes(field)) {\n    const num = parseFloat(value.replace(/[,$]/g, ''));\n    return isNaN(num) ? '' : num.toString();\n  }\n  \n  return value.trim().toLowerCase();\n}\n\nexport function parseBooleanValue(value: string): boolean {\n  const upper = (value || '').toUpperCase().trim();\n  return upper === 'SI' || upper === 'TRUE' || upper === '1' || upper === 'YES';\n}\n\nexport function parseNumericValue(value: string): number | null {\n  if (!value || value.trim() === '') return null;\n  const num = parseFloat(value.replace(/[,$]/g, ''));\n  return isNaN(num) ? null : num;\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 712, "column": 0}, "map": {"version":3,"sources":["file:///Users/jrbuenaventura/Windsurf/Mesanova/lib/csv/product-importer.ts"],"sourcesContent":["import { createClient } from '@/lib/supabase/server';\nimport {\n  ParsedProduct,\n  ProductDiff,\n  parseBooleanValue,\n  parseNumericValue,\n} from './product-parser';\nimport { ProductCSVRow } from './product-template';\n\nexport interface ImportResult {\n  success: boolean;\n  importId: string;\n  created: number;\n  updated: number;\n  skipped: number;\n  errors: ImportError[];\n}\n\nexport interface ImportError {\n  row: number;\n  ref: string;\n  error: string;\n}\n\ninterface CategoryInfo {\n  siloId: string;\n  subcategoryId: string;\n  productTypeId?: string;\n}\n\nexport async function importProducts(\n  products: ParsedProduct[],\n  diffs: ProductDiff[],\n  importMode: 'update' | 'add_only' | 'replace_all',\n  userId: string,\n  filename: string\n): Promise<ImportResult> {\n  const supabase = await createClient();\n  const errors: ImportError[] = [];\n  let created = 0;\n  let updated = 0;\n  let skipped = 0;\n  \n  // Crear registro de importación\n  const { data: importRecord, error: importError } = await supabase\n    .from('csv_imports')\n    .insert({\n      filename,\n      total_rows: products.length,\n      status: 'processing',\n      import_mode: importMode,\n      imported_by: userId,\n      started_at: new Date().toISOString(),\n    })\n    .select('id')\n    .single();\n  \n  if (importError || !importRecord) {\n    return {\n      success: false,\n      importId: '',\n      created: 0,\n      updated: 0,\n      skipped: 0,\n      errors: [{ row: 0, ref: '', error: 'Error al crear registro de importación' }],\n    };\n  }\n  \n  const importId = importRecord.id;\n  \n  // Pre-cargar categorías\n  const categoryCache = await loadCategoryCache(supabase);\n  \n  // Procesar cada producto\n  for (let i = 0; i < products.length; i++) {\n    const product = products[i];\n    const diff = diffs.find(d => d.ref === product.data.Ref);\n    \n    if (!product.isValid) {\n      skipped++;\n      continue;\n    }\n    \n    if (!diff) {\n      skipped++;\n      continue;\n    }\n    \n    try {\n      if (diff.changeType === 'create') {\n        if (importMode === 'update') {\n          // En modo update, también se crean nuevos\n          await createProduct(supabase, product.data, categoryCache, userId, importId, product.row);\n          created++;\n        } else if (importMode === 'add_only') {\n          await createProduct(supabase, product.data, categoryCache, userId, importId, product.row);\n          created++;\n        } else {\n          await createProduct(supabase, product.data, categoryCache, userId, importId, product.row);\n          created++;\n        }\n      } else if (diff.changeType === 'update') {\n        if (importMode === 'add_only') {\n          skipped++;\n        } else {\n          await updateProduct(supabase, product.data, diff, categoryCache, userId, importId, product.row);\n          updated++;\n        }\n      } else {\n        skipped++;\n      }\n    } catch (error) {\n      errors.push({\n        row: product.row,\n        ref: product.data.Ref,\n        error: error instanceof Error ? error.message : 'Error desconocido',\n      });\n    }\n  }\n  \n  // Actualizar registro de importación\n  await supabase\n    .from('csv_imports')\n    .update({\n      rows_created: created,\n      rows_updated: updated,\n      rows_skipped: skipped,\n      rows_error: errors.length,\n      errors: errors.length > 0 ? errors : null,\n      status: errors.length === 0 ? 'completed' : 'completed_with_errors',\n      completed_at: new Date().toISOString(),\n    })\n    .eq('id', importId);\n  \n  return {\n    success: errors.length === 0,\n    importId,\n    created,\n    updated,\n    skipped,\n    errors,\n  };\n}\n\nasync function loadCategoryCache(supabase: Awaited<ReturnType<typeof createClient>>) {\n  const cache: Map<string, CategoryInfo> = new Map();\n  \n  // Cargar silos\n  const { data: silos } = await supabase\n    .from('silos')\n    .select('id, slug, name');\n  \n  // Cargar subcategorías\n  const { data: subcategories } = await supabase\n    .from('subcategories')\n    .select('id, slug, name, silo_id');\n  \n  // Cargar tipos de producto\n  const { data: productTypes } = await supabase\n    .from('product_types')\n    .select('id, slug, name, subcategory_id');\n  \n  // Crear mapa combinado\n  if (silos && subcategories) {\n    for (const silo of silos) {\n      const siloSubs = subcategories.filter(s => s.silo_id === silo.id);\n      for (const sub of siloSubs) {\n        // Clave: \"categoria|subcategoria\"\n        const key = `${silo.name.toLowerCase()}|${sub.name.toLowerCase()}`;\n        cache.set(key, {\n          siloId: silo.id,\n          subcategoryId: sub.id,\n        });\n        \n        // También agregar tipos si existen\n        if (productTypes) {\n          const subTypes = productTypes.filter(t => t.subcategory_id === sub.id);\n          for (const type of subTypes) {\n            const typeKey = `${silo.name.toLowerCase()}|${sub.name.toLowerCase()}|${type.name.toLowerCase()}`;\n            cache.set(typeKey, {\n              siloId: silo.id,\n              subcategoryId: sub.id,\n              productTypeId: type.id,\n            });\n          }\n        }\n      }\n    }\n  }\n  \n  return cache;\n}\n\nfunction getCategoryInfo(\n  data: ProductCSVRow,\n  cache: Map<string, CategoryInfo>\n): CategoryInfo | null {\n  const categoria = data.Categoria?.toLowerCase().trim() || '';\n  const subcategoria = data.Subcategoria?.toLowerCase().trim() || '';\n  const tipo = data.Tipo_producto?.toLowerCase().trim() || '';\n  \n  // Intentar con los 3 niveles\n  if (tipo) {\n    const key = `${categoria}|${subcategoria}|${tipo}`;\n    const info = cache.get(key);\n    if (info) return info;\n  }\n  \n  // Intentar con 2 niveles\n  if (subcategoria) {\n    const key = `${categoria}|${subcategoria}`;\n    const info = cache.get(key);\n    if (info) return info;\n  }\n  \n  return null;\n}\n\nasync function createProduct(\n  supabase: Awaited<ReturnType<typeof createClient>>,\n  data: ProductCSVRow,\n  categoryCache: Map<string, CategoryInfo>,\n  userId: string,\n  importId: string,\n  rowNumber: number\n): Promise<void> {\n  // Generar slug\n  const slug = generateSlug(data.Producto);\n  \n  // Obtener categoría\n  const categoryInfo = getCategoryInfo(data, categoryCache);\n  \n  // Crear producto\n  const { data: product, error } = await supabase\n    .from('products')\n    .insert({\n      pdt_codigo: data.Ref,\n      codigo_barras: data.Cod_Barra || null,\n      nombre_comercial: data.Producto,\n      pdt_descripcion: data.Descripcion || null,\n      marca: data.Marca || null,\n      precio: parseNumericValue(data.Precio_COP),\n      descuento_porcentaje: parseNumericValue(data.Descuento) || 0,\n      upp_existencia: parseNumericValue(data.Existencia_inv) || 0,\n      pedido_en_camino: parseBooleanValue(data.Pedido_en_camino),\n      descontinuado: parseBooleanValue(data.Descontinuado),\n      pdt_empaque: data.Inner_pack || null,\n      outer_pack: parseNumericValue(data.Outer_pack) as number | null,\n      nombre_coleccion: data.Coleccion || null,\n      product_type_id: categoryInfo?.productTypeId || null,\n      material: data.Material || null,\n      color: data.Color || null,\n      dimensiones: data.Dimensiones || null,\n      peso: parseNumericValue(data.Peso_kg),\n      capacidad: data.Capacidad || null,\n      pais_origen: data.Pais_origen || null,\n      descripcion_larga: data.Descrip_Cliente_Final || null,\n      momentos_uso: data.Momentos_Uso_Cliente || null,\n      productos_afines_csv: data.Productos_Afines_Cliente || null,\n      descripcion_distribuidor: data.Descrip_Distribuidor || null,\n      argumentos_venta: data.Argumentos_Venta_Distribuidor || null,\n      ubicacion_tienda: data.Ubicacion_Tienda_Distribuidor || null,\n      margen_sugerido: parseNumericValue(data.Margen_Sugerido),\n      rotacion_esperada: data.Rotacion_Esperada?.toLowerCase() || null,\n      seo_title: data.SEO_Title || null,\n      seo_description: data.SEO_Description || null,\n      tags: data.Tags ? data.Tags.split(',').map(t => t.trim()) : null,\n      video_url: data.Video_URL || null,\n      ficha_tecnica_url: data.Ficha_Tecnica_URL || null,\n      fecha_lanzamiento: data.Fecha_Lanzamiento || null,\n      imagen_principal_url: data.Image_1 || null,\n      slug,\n      is_active: true,\n      is_on_sale: (parseNumericValue(data.Descuento) || 0) > 0,\n      last_csv_update: new Date().toISOString(),\n      created_by: userId,\n      updated_by: userId,\n    })\n    .select('id')\n    .single();\n  \n  if (error) {\n    throw new Error(`Error creando producto: ${error.message}`);\n  }\n  \n  // Asociar con categoría\n  if (product && categoryInfo) {\n    await supabase\n      .from('product_categories')\n      .insert({\n        product_id: product.id,\n        subcategory_id: categoryInfo.subcategoryId,\n        is_primary: true,\n      });\n  }\n  \n  // Insertar imágenes adicionales\n  if (product) {\n    await insertProductImages(supabase, product.id, data);\n  }\n  \n  // Crear log de cambio\n  await supabase\n    .from('product_change_log')\n    .insert({\n      product_id: product?.id,\n      change_type: 'create',\n      change_source: 'csv',\n      fields_changed: { all: 'new product' },\n      changed_by: userId,\n      csv_filename: importId,\n      csv_row_number: rowNumber,\n    });\n}\n\nasync function updateProduct(\n  supabase: Awaited<ReturnType<typeof createClient>>,\n  data: ProductCSVRow,\n  diff: ProductDiff,\n  categoryCache: Map<string, CategoryInfo>,\n  userId: string,\n  importId: string,\n  rowNumber: number\n): Promise<void> {\n  // Obtener producto existente\n  const { data: existingProduct } = await supabase\n    .from('products')\n    .select('id')\n    .eq('pdt_codigo', data.Ref)\n    .single();\n  \n  if (!existingProduct) {\n    throw new Error('Producto no encontrado para actualizar');\n  }\n  \n  const productId = existingProduct.id;\n  const categoryInfo = getCategoryInfo(data, categoryCache);\n  \n  // Construir objeto de actualización solo con campos cambiados\n  const updateData: Record<string, unknown> = {\n    updated_by: userId,\n    last_csv_update: new Date().toISOString(),\n    is_on_sale: (parseNumericValue(data.Descuento) || 0) > 0,\n  };\n  \n  // Mapear campos CSV a campos de BD\n  const fieldMap: Record<string, { dbField: string; transform?: (v: string) => unknown }> = {\n    Cod_Barra: { dbField: 'codigo_barras' },\n    Producto: { dbField: 'nombre_comercial' },\n    Descripcion: { dbField: 'pdt_descripcion' },\n    Marca: { dbField: 'marca' },\n    Precio_COP: { dbField: 'precio', transform: parseNumericValue },\n    Descuento: { dbField: 'descuento_porcentaje', transform: (v) => parseNumericValue(v) || 0 },\n    Existencia_inv: { dbField: 'upp_existencia', transform: (v) => parseNumericValue(v) || 0 },\n    Pedido_en_camino: { dbField: 'pedido_en_camino', transform: parseBooleanValue },\n    Descontinuado: { dbField: 'descontinuado', transform: parseBooleanValue },\n    Inner_pack: { dbField: 'pdt_empaque' },\n    Outer_pack: { dbField: 'outer_pack', transform: parseNumericValue },\n    Coleccion: { dbField: 'nombre_coleccion' },\n    Material: { dbField: 'material' },\n    Color: { dbField: 'color' },\n    Dimensiones: { dbField: 'dimensiones' },\n    Peso_kg: { dbField: 'peso', transform: parseNumericValue },\n    Capacidad: { dbField: 'capacidad' },\n    Pais_origen: { dbField: 'pais_origen' },\n    Descrip_Cliente_Final: { dbField: 'descripcion_larga' },\n    Momentos_Uso_Cliente: { dbField: 'momentos_uso' },\n    Productos_Afines_Cliente: { dbField: 'productos_afines_csv' },\n    Descrip_Distribuidor: { dbField: 'descripcion_distribuidor' },\n    Argumentos_Venta_Distribuidor: { dbField: 'argumentos_venta' },\n    Ubicacion_Tienda_Distribuidor: { dbField: 'ubicacion_tienda' },\n    Margen_Sugerido: { dbField: 'margen_sugerido', transform: parseNumericValue },\n    Rotacion_Esperada: { dbField: 'rotacion_esperada', transform: (v) => v?.toLowerCase() || null },\n    SEO_Title: { dbField: 'seo_title' },\n    SEO_Description: { dbField: 'seo_description' },\n    Tags: { dbField: 'tags', transform: (v) => v ? v.split(',').map(t => t.trim()) : null },\n    Video_URL: { dbField: 'video_url' },\n    Ficha_Tecnica_URL: { dbField: 'ficha_tecnica_url' },\n    Fecha_Lanzamiento: { dbField: 'fecha_lanzamiento' },\n    Image_1: { dbField: 'imagen_principal_url' },\n  };\n  \n  for (const change of diff.changes) {\n    const mapping = fieldMap[change.field];\n    if (mapping) {\n      const value = data[change.field as keyof ProductCSVRow];\n      updateData[mapping.dbField] = mapping.transform \n        ? mapping.transform(value) \n        : (value || null);\n    }\n  }\n  \n  // Actualizar producto\n  const { error } = await supabase\n    .from('products')\n    .update(updateData)\n    .eq('id', productId);\n  \n  if (error) {\n    throw new Error(`Error actualizando producto: ${error.message}`);\n  }\n  \n  // Actualizar tipo de producto si cambió\n  if (categoryInfo?.productTypeId) {\n    await supabase\n      .from('products')\n      .update({ product_type_id: categoryInfo.productTypeId })\n      .eq('id', productId);\n  }\n  \n  // Actualizar imágenes si cambiaron\n  const imageChanges = diff.changes.filter(c => c.field.startsWith('Image_'));\n  if (imageChanges.length > 0) {\n    // Eliminar imágenes existentes y reinsertar\n    await supabase\n      .from('product_media')\n      .delete()\n      .eq('product_id', productId);\n    \n    await insertProductImages(supabase, productId, data);\n  }\n  \n  // Crear log de cambio\n  const changesJson: Record<string, { old: string | null; new: string | null }> = {};\n  for (const change of diff.changes) {\n    changesJson[change.field] = {\n      old: change.oldValue,\n      new: change.newValue,\n    };\n  }\n  \n  await supabase\n    .from('product_change_log')\n    .insert({\n      product_id: productId,\n      change_type: 'update',\n      change_source: 'csv',\n      fields_changed: changesJson,\n      changed_by: userId,\n      csv_filename: importId,\n      csv_row_number: rowNumber,\n    });\n}\n\nasync function insertProductImages(\n  supabase: Awaited<ReturnType<typeof createClient>>,\n  productId: string,\n  data: ProductCSVRow\n): Promise<void> {\n  const images: { product_id: string; media_type: string; url: string; order_index: number }[] = [];\n  \n  const imageFields: (keyof ProductCSVRow)[] = [\n    'Image_2', 'Image_3', 'Image_4', 'Image_5',\n    'Image_6', 'Image_7', 'Image_8', 'Image_9', 'Image_10',\n  ];\n  \n  for (let i = 0; i < imageFields.length; i++) {\n    const url = data[imageFields[i]];\n    if (url && url.trim() !== '') {\n      images.push({\n        product_id: productId,\n        media_type: 'image',\n        url: url.trim(),\n        order_index: i + 2, // Image_1 es principal, estas empiezan en 2\n      });\n    }\n  }\n  \n  if (images.length > 0) {\n    await supabase.from('product_media').insert(images);\n  }\n}\n\nfunction generateSlug(name: string): string {\n  return name\n    .toLowerCase()\n    .normalize('NFD')\n    .replace(/[\\u0300-\\u036f]/g, '') // Remover acentos\n    .replace(/[^a-z0-9\\s-]/g, '') // Solo alfanuméricos\n    .replace(/\\s+/g, '-') // Espacios a guiones\n    .replace(/-+/g, '-') // Múltiples guiones a uno\n    .replace(/^-|-$/g, ''); // Remover guiones inicio/fin\n}\n\nexport async function getExistingProductsMap(\n  supabase: Awaited<ReturnType<typeof createClient>>\n): Promise<Map<string, Record<string, unknown>>> {\n  const { data: products } = await supabase\n    .from('products')\n    .select('*');\n  \n  const map = new Map<string, Record<string, unknown>>();\n  if (products) {\n    for (const product of products) {\n      map.set(product.pdt_codigo, product);\n    }\n  }\n  \n  return map;\n}\n\nexport async function exportProductsToCSV(\n  supabase: Awaited<ReturnType<typeof createClient>>\n): Promise<string> {\n  const { data: products } = await supabase\n    .from('products')\n    .select(`\n      *,\n      product_categories!inner(\n        subcategory:subcategories(\n          name,\n          silo:silos(name)\n        )\n      ),\n      product_type:product_types(name),\n      product_media(url, order_index)\n    `)\n    .order('pdt_codigo');\n  \n  if (!products || products.length === 0) {\n    return '';\n  }\n  \n  const { CSV_HEADERS } = await import('./product-template');\n  \n  const rows: string[] = [CSV_HEADERS.join(',')];\n  \n  for (const product of products) {\n    const category = product.product_categories?.[0]?.subcategory;\n    const images = product.product_media?.sort((a: { order_index: number }, b: { order_index: number }) => a.order_index - b.order_index) || [];\n    \n    const row: string[] = [\n      escapeCSV(product.pdt_codigo || ''),\n      escapeCSV(product.codigo_barras || ''),\n      escapeCSV(product.nombre_comercial || ''),\n      escapeCSV(product.pdt_descripcion || ''),\n      escapeCSV(product.marca || ''),\n      String(product.precio || ''),\n      String(product.descuento_porcentaje || '0'),\n      String(product.upp_existencia || '0'),\n      product.pedido_en_camino ? 'SI' : 'NO',\n      product.descontinuado ? 'SI' : 'NO',\n      escapeCSV(product.pdt_empaque || ''),\n      String(product.outer_pack || ''),\n      escapeCSV(product.nombre_coleccion || ''),\n      escapeCSV(category?.silo?.name || ''),\n      escapeCSV(category?.name || ''),\n      escapeCSV(product.product_type?.name || ''),\n      escapeCSV(product.material || ''),\n      escapeCSV(product.color || ''),\n      escapeCSV(product.dimensiones || ''),\n      String(product.peso || ''),\n      escapeCSV(product.capacidad || ''),\n      escapeCSV(product.pais_origen || ''),\n      escapeCSV(product.descripcion_larga || ''),\n      escapeCSV(product.momentos_uso || ''),\n      escapeCSV(product.productos_afines_csv || ''),\n      escapeCSV(product.descripcion_distribuidor || ''),\n      escapeCSV(product.argumentos_venta || ''),\n      escapeCSV(product.ubicacion_tienda || ''),\n      String(product.margen_sugerido || ''),\n      escapeCSV(product.rotacion_esperada || ''),\n      escapeCSV(product.seo_title || ''),\n      escapeCSV(product.seo_description || ''),\n      escapeCSV((product.tags || []).join(',')),\n      escapeCSV(product.video_url || ''),\n      escapeCSV(product.ficha_tecnica_url || ''),\n      escapeCSV(product.fecha_lanzamiento || ''),\n      escapeCSV(product.imagen_principal_url || ''),\n      ...Array.from({ length: 9 }, (_, i) => {\n        const img = images.find((m: { order_index: number }) => m.order_index === i + 2);\n        return escapeCSV(img?.url || '');\n      }),\n    ];\n    \n    rows.push(row.join(','));\n  }\n  \n  return rows.join('\\n');\n}\n\nfunction escapeCSV(value: string): string {\n  if (!value) return '';\n  if (value.includes(',') || value.includes('\"') || value.includes('\\n')) {\n    return `\"${value.replace(/\"/g, '\"\"')}\"`;\n  }\n  return value;\n}\n"],"names":[],"mappings":";;;;;;;;AAAA;AACA;;;AA6BO,eAAe,eACpB,QAAyB,EACzB,KAAoB,EACpB,UAAiD,EACjD,MAAc,EACd,QAAgB;IAEhB,MAAM,WAAW,MAAM,IAAA,2IAAY;IACnC,MAAM,SAAwB,EAAE;IAChC,IAAI,UAAU;IACd,IAAI,UAAU;IACd,IAAI,UAAU;IAEd,gCAAgC;IAChC,MAAM,EAAE,MAAM,YAAY,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,SACtD,IAAI,CAAC,eACL,MAAM,CAAC;QACN;QACA,YAAY,SAAS,MAAM;QAC3B,QAAQ;QACR,aAAa;QACb,aAAa;QACb,YAAY,IAAI,OAAO,WAAW;IACpC,GACC,MAAM,CAAC,MACP,MAAM;IAET,IAAI,eAAe,CAAC,cAAc;QAChC,OAAO;YACL,SAAS;YACT,UAAU;YACV,SAAS;YACT,SAAS;YACT,SAAS;YACT,QAAQ;gBAAC;oBAAE,KAAK;oBAAG,KAAK;oBAAI,OAAO;gBAAyC;aAAE;QAChF;IACF;IAEA,MAAM,WAAW,aAAa,EAAE;IAEhC,wBAAwB;IACxB,MAAM,gBAAgB,MAAM,kBAAkB;IAE9C,yBAAyB;IACzB,IAAK,IAAI,IAAI,GAAG,IAAI,SAAS,MAAM,EAAE,IAAK;QACxC,MAAM,UAAU,QAAQ,CAAC,EAAE;QAC3B,MAAM,OAAO,MAAM,IAAI,CAAC,CAAA,IAAK,EAAE,GAAG,KAAK,QAAQ,IAAI,CAAC,GAAG;QAEvD,IAAI,CAAC,QAAQ,OAAO,EAAE;YACpB;YACA;QACF;QAEA,IAAI,CAAC,MAAM;YACT;YACA;QACF;QAEA,IAAI;YACF,IAAI,KAAK,UAAU,KAAK,UAAU;gBAChC,IAAI,eAAe,UAAU;oBAC3B,0CAA0C;oBAC1C,MAAM,cAAc,UAAU,QAAQ,IAAI,EAAE,eAAe,QAAQ,UAAU,QAAQ,GAAG;oBACxF;gBACF,OAAO,IAAI,eAAe,YAAY;oBACpC,MAAM,cAAc,UAAU,QAAQ,IAAI,EAAE,eAAe,QAAQ,UAAU,QAAQ,GAAG;oBACxF;gBACF,OAAO;oBACL,MAAM,cAAc,UAAU,QAAQ,IAAI,EAAE,eAAe,QAAQ,UAAU,QAAQ,GAAG;oBACxF;gBACF;YACF,OAAO,IAAI,KAAK,UAAU,KAAK,UAAU;gBACvC,IAAI,eAAe,YAAY;oBAC7B;gBACF,OAAO;oBACL,MAAM,cAAc,UAAU,QAAQ,IAAI,EAAE,MAAM,eAAe,QAAQ,UAAU,QAAQ,GAAG;oBAC9F;gBACF;YACF,OAAO;gBACL;YACF;QACF,EAAE,OAAO,OAAO;YACd,OAAO,IAAI,CAAC;gBACV,KAAK,QAAQ,GAAG;gBAChB,KAAK,QAAQ,IAAI,CAAC,GAAG;gBACrB,OAAO,iBAAiB,QAAQ,MAAM,OAAO,GAAG;YAClD;QACF;IACF;IAEA,qCAAqC;IACrC,MAAM,SACH,IAAI,CAAC,eACL,MAAM,CAAC;QACN,cAAc;QACd,cAAc;QACd,cAAc;QACd,YAAY,OAAO,MAAM;QACzB,QAAQ,OAAO,MAAM,GAAG,IAAI,SAAS;QACrC,QAAQ,OAAO,MAAM,KAAK,IAAI,cAAc;QAC5C,cAAc,IAAI,OAAO,WAAW;IACtC,GACC,EAAE,CAAC,MAAM;IAEZ,OAAO;QACL,SAAS,OAAO,MAAM,KAAK;QAC3B;QACA;QACA;QACA;QACA;IACF;AACF;AAEA,eAAe,kBAAkB,QAAkD;IACjF,MAAM,QAAmC,IAAI;IAE7C,eAAe;IACf,MAAM,EAAE,MAAM,KAAK,EAAE,GAAG,MAAM,SAC3B,IAAI,CAAC,SACL,MAAM,CAAC;IAEV,uBAAuB;IACvB,MAAM,EAAE,MAAM,aAAa,EAAE,GAAG,MAAM,SACnC,IAAI,CAAC,iBACL,MAAM,CAAC;IAEV,2BAA2B;IAC3B,MAAM,EAAE,MAAM,YAAY,EAAE,GAAG,MAAM,SAClC,IAAI,CAAC,iBACL,MAAM,CAAC;IAEV,uBAAuB;IACvB,IAAI,SAAS,eAAe;QAC1B,KAAK,MAAM,QAAQ,MAAO;YACxB,MAAM,WAAW,cAAc,MAAM,CAAC,CAAA,IAAK,EAAE,OAAO,KAAK,KAAK,EAAE;YAChE,KAAK,MAAM,OAAO,SAAU;gBAC1B,kCAAkC;gBAClC,MAAM,MAAM,GAAG,KAAK,IAAI,CAAC,WAAW,GAAG,CAAC,EAAE,IAAI,IAAI,CAAC,WAAW,IAAI;gBAClE,MAAM,GAAG,CAAC,KAAK;oBACb,QAAQ,KAAK,EAAE;oBACf,eAAe,IAAI,EAAE;gBACvB;gBAEA,mCAAmC;gBACnC,IAAI,cAAc;oBAChB,MAAM,WAAW,aAAa,MAAM,CAAC,CAAA,IAAK,EAAE,cAAc,KAAK,IAAI,EAAE;oBACrE,KAAK,MAAM,QAAQ,SAAU;wBAC3B,MAAM,UAAU,GAAG,KAAK,IAAI,CAAC,WAAW,GAAG,CAAC,EAAE,IAAI,IAAI,CAAC,WAAW,GAAG,CAAC,EAAE,KAAK,IAAI,CAAC,WAAW,IAAI;wBACjG,MAAM,GAAG,CAAC,SAAS;4BACjB,QAAQ,KAAK,EAAE;4BACf,eAAe,IAAI,EAAE;4BACrB,eAAe,KAAK,EAAE;wBACxB;oBACF;gBACF;YACF;QACF;IACF;IAEA,OAAO;AACT;AAEA,SAAS,gBACP,IAAmB,EACnB,KAAgC;IAEhC,MAAM,YAAY,KAAK,SAAS,EAAE,cAAc,UAAU;IAC1D,MAAM,eAAe,KAAK,YAAY,EAAE,cAAc,UAAU;IAChE,MAAM,OAAO,KAAK,aAAa,EAAE,cAAc,UAAU;IAEzD,6BAA6B;IAC7B,IAAI,MAAM;QACR,MAAM,MAAM,GAAG,UAAU,CAAC,EAAE,aAAa,CAAC,EAAE,MAAM;QAClD,MAAM,OAAO,MAAM,GAAG,CAAC;QACvB,IAAI,MAAM,OAAO;IACnB;IAEA,yBAAyB;IACzB,IAAI,cAAc;QAChB,MAAM,MAAM,GAAG,UAAU,CAAC,EAAE,cAAc;QAC1C,MAAM,OAAO,MAAM,GAAG,CAAC;QACvB,IAAI,MAAM,OAAO;IACnB;IAEA,OAAO;AACT;AAEA,eAAe,cACb,QAAkD,EAClD,IAAmB,EACnB,aAAwC,EACxC,MAAc,EACd,QAAgB,EAChB,SAAiB;IAEjB,eAAe;IACf,MAAM,OAAO,aAAa,KAAK,QAAQ;IAEvC,oBAAoB;IACpB,MAAM,eAAe,gBAAgB,MAAM;IAE3C,iBAAiB;IACjB,MAAM,EAAE,MAAM,OAAO,EAAE,KAAK,EAAE,GAAG,MAAM,SACpC,IAAI,CAAC,YACL,MAAM,CAAC;QACN,YAAY,KAAK,GAAG;QACpB,eAAe,KAAK,SAAS,IAAI;QACjC,kBAAkB,KAAK,QAAQ;QAC/B,iBAAiB,KAAK,WAAW,IAAI;QACrC,OAAO,KAAK,KAAK,IAAI;QACrB,QAAQ,IAAA,sJAAiB,EAAC,KAAK,UAAU;QACzC,sBAAsB,IAAA,sJAAiB,EAAC,KAAK,SAAS,KAAK;QAC3D,gBAAgB,IAAA,sJAAiB,EAAC,KAAK,cAAc,KAAK;QAC1D,kBAAkB,IAAA,sJAAiB,EAAC,KAAK,gBAAgB;QACzD,eAAe,IAAA,sJAAiB,EAAC,KAAK,aAAa;QACnD,aAAa,KAAK,UAAU,IAAI;QAChC,YAAY,IAAA,sJAAiB,EAAC,KAAK,UAAU;QAC7C,kBAAkB,KAAK,SAAS,IAAI;QACpC,iBAAiB,cAAc,iBAAiB;QAChD,UAAU,KAAK,QAAQ,IAAI;QAC3B,OAAO,KAAK,KAAK,IAAI;QACrB,aAAa,KAAK,WAAW,IAAI;QACjC,MAAM,IAAA,sJAAiB,EAAC,KAAK,OAAO;QACpC,WAAW,KAAK,SAAS,IAAI;QAC7B,aAAa,KAAK,WAAW,IAAI;QACjC,mBAAmB,KAAK,qBAAqB,IAAI;QACjD,cAAc,KAAK,oBAAoB,IAAI;QAC3C,sBAAsB,KAAK,wBAAwB,IAAI;QACvD,0BAA0B,KAAK,oBAAoB,IAAI;QACvD,kBAAkB,KAAK,6BAA6B,IAAI;QACxD,kBAAkB,KAAK,6BAA6B,IAAI;QACxD,iBAAiB,IAAA,sJAAiB,EAAC,KAAK,eAAe;QACvD,mBAAmB,KAAK,iBAAiB,EAAE,iBAAiB;QAC5D,WAAW,KAAK,SAAS,IAAI;QAC7B,iBAAiB,KAAK,eAAe,IAAI;QACzC,MAAM,KAAK,IAAI,GAAG,KAAK,IAAI,CAAC,KAAK,CAAC,KAAK,GAAG,CAAC,CAAA,IAAK,EAAE,IAAI,MAAM;QAC5D,WAAW,KAAK,SAAS,IAAI;QAC7B,mBAAmB,KAAK,iBAAiB,IAAI;QAC7C,mBAAmB,KAAK,iBAAiB,IAAI;QAC7C,sBAAsB,KAAK,OAAO,IAAI;QACtC;QACA,WAAW;QACX,YAAY,CAAC,IAAA,sJAAiB,EAAC,KAAK,SAAS,KAAK,CAAC,IAAI;QACvD,iBAAiB,IAAI,OAAO,WAAW;QACvC,YAAY;QACZ,YAAY;IACd,GACC,MAAM,CAAC,MACP,MAAM;IAET,IAAI,OAAO;QACT,MAAM,IAAI,MAAM,CAAC,wBAAwB,EAAE,MAAM,OAAO,EAAE;IAC5D;IAEA,wBAAwB;IACxB,IAAI,WAAW,cAAc;QAC3B,MAAM,SACH,IAAI,CAAC,sBACL,MAAM,CAAC;YACN,YAAY,QAAQ,EAAE;YACtB,gBAAgB,aAAa,aAAa;YAC1C,YAAY;QACd;IACJ;IAEA,gCAAgC;IAChC,IAAI,SAAS;QACX,MAAM,oBAAoB,UAAU,QAAQ,EAAE,EAAE;IAClD;IAEA,sBAAsB;IACtB,MAAM,SACH,IAAI,CAAC,sBACL,MAAM,CAAC;QACN,YAAY,SAAS;QACrB,aAAa;QACb,eAAe;QACf,gBAAgB;YAAE,KAAK;QAAc;QACrC,YAAY;QACZ,cAAc;QACd,gBAAgB;IAClB;AACJ;AAEA,eAAe,cACb,QAAkD,EAClD,IAAmB,EACnB,IAAiB,EACjB,aAAwC,EACxC,MAAc,EACd,QAAgB,EAChB,SAAiB;IAEjB,6BAA6B;IAC7B,MAAM,EAAE,MAAM,eAAe,EAAE,GAAG,MAAM,SACrC,IAAI,CAAC,YACL,MAAM,CAAC,MACP,EAAE,CAAC,cAAc,KAAK,GAAG,EACzB,MAAM;IAET,IAAI,CAAC,iBAAiB;QACpB,MAAM,IAAI,MAAM;IAClB;IAEA,MAAM,YAAY,gBAAgB,EAAE;IACpC,MAAM,eAAe,gBAAgB,MAAM;IAE3C,8DAA8D;IAC9D,MAAM,aAAsC;QAC1C,YAAY;QACZ,iBAAiB,IAAI,OAAO,WAAW;QACvC,YAAY,CAAC,IAAA,sJAAiB,EAAC,KAAK,SAAS,KAAK,CAAC,IAAI;IACzD;IAEA,mCAAmC;IACnC,MAAM,WAAoF;QACxF,WAAW;YAAE,SAAS;QAAgB;QACtC,UAAU;YAAE,SAAS;QAAmB;QACxC,aAAa;YAAE,SAAS;QAAkB;QAC1C,OAAO;YAAE,SAAS;QAAQ;QAC1B,YAAY;YAAE,SAAS;YAAU,WAAW,sJAAiB;QAAC;QAC9D,WAAW;YAAE,SAAS;YAAwB,WAAW,CAAC,IAAM,IAAA,sJAAiB,EAAC,MAAM;QAAE;QAC1F,gBAAgB;YAAE,SAAS;YAAkB,WAAW,CAAC,IAAM,IAAA,sJAAiB,EAAC,MAAM;QAAE;QACzF,kBAAkB;YAAE,SAAS;YAAoB,WAAW,sJAAiB;QAAC;QAC9E,eAAe;YAAE,SAAS;YAAiB,WAAW,sJAAiB;QAAC;QACxE,YAAY;YAAE,SAAS;QAAc;QACrC,YAAY;YAAE,SAAS;YAAc,WAAW,sJAAiB;QAAC;QAClE,WAAW;YAAE,SAAS;QAAmB;QACzC,UAAU;YAAE,SAAS;QAAW;QAChC,OAAO;YAAE,SAAS;QAAQ;QAC1B,aAAa;YAAE,SAAS;QAAc;QACtC,SAAS;YAAE,SAAS;YAAQ,WAAW,sJAAiB;QAAC;QACzD,WAAW;YAAE,SAAS;QAAY;QAClC,aAAa;YAAE,SAAS;QAAc;QACtC,uBAAuB;YAAE,SAAS;QAAoB;QACtD,sBAAsB;YAAE,SAAS;QAAe;QAChD,0BAA0B;YAAE,SAAS;QAAuB;QAC5D,sBAAsB;YAAE,SAAS;QAA2B;QAC5D,+BAA+B;YAAE,SAAS;QAAmB;QAC7D,+BAA+B;YAAE,SAAS;QAAmB;QAC7D,iBAAiB;YAAE,SAAS;YAAmB,WAAW,sJAAiB;QAAC;QAC5E,mBAAmB;YAAE,SAAS;YAAqB,WAAW,CAAC,IAAM,GAAG,iBAAiB;QAAK;QAC9F,WAAW;YAAE,SAAS;QAAY;QAClC,iBAAiB;YAAE,SAAS;QAAkB;QAC9C,MAAM;YAAE,SAAS;YAAQ,WAAW,CAAC,IAAM,IAAI,EAAE,KAAK,CAAC,KAAK,GAAG,CAAC,CAAA,IAAK,EAAE,IAAI,MAAM;QAAK;QACtF,WAAW;YAAE,SAAS;QAAY;QAClC,mBAAmB;YAAE,SAAS;QAAoB;QAClD,mBAAmB;YAAE,SAAS;QAAoB;QAClD,SAAS;YAAE,SAAS;QAAuB;IAC7C;IAEA,KAAK,MAAM,UAAU,KAAK,OAAO,CAAE;QACjC,MAAM,UAAU,QAAQ,CAAC,OAAO,KAAK,CAAC;QACtC,IAAI,SAAS;YACX,MAAM,QAAQ,IAAI,CAAC,OAAO,KAAK,CAAwB;YACvD,UAAU,CAAC,QAAQ,OAAO,CAAC,GAAG,QAAQ,SAAS,GAC3C,QAAQ,SAAS,CAAC,SACjB,SAAS;QAChB;IACF;IAEA,sBAAsB;IACtB,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,SACrB,IAAI,CAAC,YACL,MAAM,CAAC,YACP,EAAE,CAAC,MAAM;IAEZ,IAAI,OAAO;QACT,MAAM,IAAI,MAAM,CAAC,6BAA6B,EAAE,MAAM,OAAO,EAAE;IACjE;IAEA,wCAAwC;IACxC,IAAI,cAAc,eAAe;QAC/B,MAAM,SACH,IAAI,CAAC,YACL,MAAM,CAAC;YAAE,iBAAiB,aAAa,aAAa;QAAC,GACrD,EAAE,CAAC,MAAM;IACd;IAEA,mCAAmC;IACnC,MAAM,eAAe,KAAK,OAAO,CAAC,MAAM,CAAC,CAAA,IAAK,EAAE,KAAK,CAAC,UAAU,CAAC;IACjE,IAAI,aAAa,MAAM,GAAG,GAAG;QAC3B,4CAA4C;QAC5C,MAAM,SACH,IAAI,CAAC,iBACL,MAAM,GACN,EAAE,CAAC,cAAc;QAEpB,MAAM,oBAAoB,UAAU,WAAW;IACjD;IAEA,sBAAsB;IACtB,MAAM,cAA0E,CAAC;IACjF,KAAK,MAAM,UAAU,KAAK,OAAO,CAAE;QACjC,WAAW,CAAC,OAAO,KAAK,CAAC,GAAG;YAC1B,KAAK,OAAO,QAAQ;YACpB,KAAK,OAAO,QAAQ;QACtB;IACF;IAEA,MAAM,SACH,IAAI,CAAC,sBACL,MAAM,CAAC;QACN,YAAY;QACZ,aAAa;QACb,eAAe;QACf,gBAAgB;QAChB,YAAY;QACZ,cAAc;QACd,gBAAgB;IAClB;AACJ;AAEA,eAAe,oBACb,QAAkD,EAClD,SAAiB,EACjB,IAAmB;IAEnB,MAAM,SAAyF,EAAE;IAEjG,MAAM,cAAuC;QAC3C;QAAW;QAAW;QAAW;QACjC;QAAW;QAAW;QAAW;QAAW;KAC7C;IAED,IAAK,IAAI,IAAI,GAAG,IAAI,YAAY,MAAM,EAAE,IAAK;QAC3C,MAAM,MAAM,IAAI,CAAC,WAAW,CAAC,EAAE,CAAC;QAChC,IAAI,OAAO,IAAI,IAAI,OAAO,IAAI;YAC5B,OAAO,IAAI,CAAC;gBACV,YAAY;gBACZ,YAAY;gBACZ,KAAK,IAAI,IAAI;gBACb,aAAa,IAAI;YACnB;QACF;IACF;IAEA,IAAI,OAAO,MAAM,GAAG,GAAG;QACrB,MAAM,SAAS,IAAI,CAAC,iBAAiB,MAAM,CAAC;IAC9C;AACF;AAEA,SAAS,aAAa,IAAY;IAChC,OAAO,KACJ,WAAW,GACX,SAAS,CAAC,OACV,OAAO,CAAC,oBAAoB,IAAI,kBAAkB;KAClD,OAAO,CAAC,iBAAiB,IAAI,qBAAqB;KAClD,OAAO,CAAC,QAAQ,KAAK,qBAAqB;KAC1C,OAAO,CAAC,OAAO,KAAK,0BAA0B;KAC9C,OAAO,CAAC,UAAU,KAAK,6BAA6B;AACzD;AAEO,eAAe,uBACpB,QAAkD;IAElD,MAAM,EAAE,MAAM,QAAQ,EAAE,GAAG,MAAM,SAC9B,IAAI,CAAC,YACL,MAAM,CAAC;IAEV,MAAM,MAAM,IAAI;IAChB,IAAI,UAAU;QACZ,KAAK,MAAM,WAAW,SAAU;YAC9B,IAAI,GAAG,CAAC,QAAQ,UAAU,EAAE;QAC9B;IACF;IAEA,OAAO;AACT;AAEO,eAAe,oBACpB,QAAkD;IAElD,MAAM,EAAE,MAAM,QAAQ,EAAE,GAAG,MAAM,SAC9B,IAAI,CAAC,YACL,MAAM,CAAC,CAAC;;;;;;;;;;IAUT,CAAC,EACA,KAAK,CAAC;IAET,IAAI,CAAC,YAAY,SAAS,MAAM,KAAK,GAAG;QACtC,OAAO;IACT;IAEA,MAAM,EAAE,WAAW,EAAE,GAAG;IAExB,MAAM,OAAiB;QAAC,YAAY,IAAI,CAAC;KAAK;IAE9C,KAAK,MAAM,WAAW,SAAU;QAC9B,MAAM,WAAW,QAAQ,kBAAkB,EAAE,CAAC,EAAE,EAAE;QAClD,MAAM,SAAS,QAAQ,aAAa,EAAE,KAAK,CAAC,GAA4B,IAA+B,EAAE,WAAW,GAAG,EAAE,WAAW,KAAK,EAAE;QAE3I,MAAM,MAAgB;YACpB,UAAU,QAAQ,UAAU,IAAI;YAChC,UAAU,QAAQ,aAAa,IAAI;YACnC,UAAU,QAAQ,gBAAgB,IAAI;YACtC,UAAU,QAAQ,eAAe,IAAI;YACrC,UAAU,QAAQ,KAAK,IAAI;YAC3B,OAAO,QAAQ,MAAM,IAAI;YACzB,OAAO,QAAQ,oBAAoB,IAAI;YACvC,OAAO,QAAQ,cAAc,IAAI;YACjC,QAAQ,gBAAgB,GAAG,OAAO;YAClC,QAAQ,aAAa,GAAG,OAAO;YAC/B,UAAU,QAAQ,WAAW,IAAI;YACjC,OAAO,QAAQ,UAAU,IAAI;YAC7B,UAAU,QAAQ,gBAAgB,IAAI;YACtC,UAAU,UAAU,MAAM,QAAQ;YAClC,UAAU,UAAU,QAAQ;YAC5B,UAAU,QAAQ,YAAY,EAAE,QAAQ;YACxC,UAAU,QAAQ,QAAQ,IAAI;YAC9B,UAAU,QAAQ,KAAK,IAAI;YAC3B,UAAU,QAAQ,WAAW,IAAI;YACjC,OAAO,QAAQ,IAAI,IAAI;YACvB,UAAU,QAAQ,SAAS,IAAI;YAC/B,UAAU,QAAQ,WAAW,IAAI;YACjC,UAAU,QAAQ,iBAAiB,IAAI;YACvC,UAAU,QAAQ,YAAY,IAAI;YAClC,UAAU,QAAQ,oBAAoB,IAAI;YAC1C,UAAU,QAAQ,wBAAwB,IAAI;YAC9C,UAAU,QAAQ,gBAAgB,IAAI;YACtC,UAAU,QAAQ,gBAAgB,IAAI;YACtC,OAAO,QAAQ,eAAe,IAAI;YAClC,UAAU,QAAQ,iBAAiB,IAAI;YACvC,UAAU,QAAQ,SAAS,IAAI;YAC/B,UAAU,QAAQ,eAAe,IAAI;YACrC,UAAU,CAAC,QAAQ,IAAI,IAAI,EAAE,EAAE,IAAI,CAAC;YACpC,UAAU,QAAQ,SAAS,IAAI;YAC/B,UAAU,QAAQ,iBAAiB,IAAI;YACvC,UAAU,QAAQ,iBAAiB,IAAI;YACvC,UAAU,QAAQ,oBAAoB,IAAI;eACvC,MAAM,IAAI,CAAC;gBAAE,QAAQ;YAAE,GAAG,CAAC,GAAG;gBAC/B,MAAM,MAAM,OAAO,IAAI,CAAC,CAAC,IAA+B,EAAE,WAAW,KAAK,IAAI;gBAC9E,OAAO,UAAU,KAAK,OAAO;YAC/B;SACD;QAED,KAAK,IAAI,CAAC,IAAI,IAAI,CAAC;IACrB;IAEA,OAAO,KAAK,IAAI,CAAC;AACnB;AAEA,SAAS,UAAU,KAAa;IAC9B,IAAI,CAAC,OAAO,OAAO;IACnB,IAAI,MAAM,QAAQ,CAAC,QAAQ,MAAM,QAAQ,CAAC,QAAQ,MAAM,QAAQ,CAAC,OAAO;QACtE,OAAO,CAAC,CAAC,EAAE,MAAM,OAAO,CAAC,MAAM,MAAM,CAAC,CAAC;IACzC;IACA,OAAO;AACT"}},
    {"offset": {"line": 1247, "column": 0}, "map": {"version":3,"sources":["file:///Users/jrbuenaventura/Windsurf/Mesanova/app/api/products/csv/validate/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { createClient } from '@/lib/supabase/server';\nimport { parseCSV, compareWithExisting } from '@/lib/csv/product-parser';\nimport { getExistingProductsMap } from '@/lib/csv/product-importer';\n\nexport async function POST(request: Request) {\n  try {\n    const supabase = await createClient();\n    \n    // Verificar autenticación\n    const { data: { user }, error: authError } = await supabase.auth.getUser();\n    \n    if (authError || !user) {\n      return NextResponse.json({ error: 'No autorizado' }, { status: 401 });\n    }\n    \n    // Verificar rol de superadmin\n    const { data: profile } = await supabase\n      .from('user_profiles')\n      .select('role')\n      .eq('id', user.id)\n      .single();\n    \n    if (profile?.role !== 'superadmin') {\n      return NextResponse.json({ error: 'No autorizado' }, { status: 403 });\n    }\n    \n    // Obtener contenido del archivo\n    const formData = await request.formData();\n    const file = formData.get('file') as File;\n    \n    if (!file) {\n      return NextResponse.json({ error: 'No se proporcionó archivo' }, { status: 400 });\n    }\n    \n    // Leer contenido\n    const content = await file.text();\n    \n    // Parsear y validar CSV\n    const parseResult = parseCSV(content);\n    \n    // Obtener productos existentes para comparación\n    const existingProducts = await getExistingProductsMap(supabase);\n    \n    // Comparar con existentes\n    const diffs = compareWithExisting(parseResult.products, existingProducts);\n    \n    // Calcular estadísticas\n    const stats = {\n      total: parseResult.totalRows,\n      valid: parseResult.validRows,\n      invalid: parseResult.invalidRows,\n      toCreate: diffs.filter(d => d.changeType === 'create').length,\n      toUpdate: diffs.filter(d => d.changeType === 'update').length,\n      unchanged: diffs.filter(d => d.changeType === 'unchanged').length,\n    };\n    \n    return NextResponse.json({\n      success: parseResult.success,\n      stats,\n      globalErrors: parseResult.globalErrors,\n      products: parseResult.products.slice(0, 100), // Limitar preview a 100 productos\n      diffs: diffs.slice(0, 100),\n      hasMore: parseResult.products.length > 100,\n    });\n  } catch (error) {\n    console.error('Error validando CSV:', error);\n    return NextResponse.json(\n      { error: 'Error al validar archivo CSV' },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;;;;;AAEO,eAAe,KAAK,OAAgB;IACzC,IAAI;QACF,MAAM,WAAW,MAAM,IAAA,2IAAY;QAEnC,0BAA0B;QAC1B,MAAM,EAAE,MAAM,EAAE,IAAI,EAAE,EAAE,OAAO,SAAS,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO;QAExE,IAAI,aAAa,CAAC,MAAM;YACtB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAgB,GAAG;gBAAE,QAAQ;YAAI;QACrE;QAEA,8BAA8B;QAC9B,MAAM,EAAE,MAAM,OAAO,EAAE,GAAG,MAAM,SAC7B,IAAI,CAAC,iBACL,MAAM,CAAC,QACP,EAAE,CAAC,MAAM,KAAK,EAAE,EAChB,MAAM;QAET,IAAI,SAAS,SAAS,cAAc;YAClC,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAgB,GAAG;gBAAE,QAAQ;YAAI;QACrE;QAEA,gCAAgC;QAChC,MAAM,WAAW,MAAM,QAAQ,QAAQ;QACvC,MAAM,OAAO,SAAS,GAAG,CAAC;QAE1B,IAAI,CAAC,MAAM;YACT,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA4B,GAAG;gBAAE,QAAQ;YAAI;QACjF;QAEA,iBAAiB;QACjB,MAAM,UAAU,MAAM,KAAK,IAAI;QAE/B,wBAAwB;QACxB,MAAM,cAAc,IAAA,6IAAQ,EAAC;QAE7B,gDAAgD;QAChD,MAAM,mBAAmB,MAAM,IAAA,6JAAsB,EAAC;QAEtD,0BAA0B;QAC1B,MAAM,QAAQ,IAAA,wJAAmB,EAAC,YAAY,QAAQ,EAAE;QAExD,wBAAwB;QACxB,MAAM,QAAQ;YACZ,OAAO,YAAY,SAAS;YAC5B,OAAO,YAAY,SAAS;YAC5B,SAAS,YAAY,WAAW;YAChC,UAAU,MAAM,MAAM,CAAC,CAAA,IAAK,EAAE,UAAU,KAAK,UAAU,MAAM;YAC7D,UAAU,MAAM,MAAM,CAAC,CAAA,IAAK,EAAE,UAAU,KAAK,UAAU,MAAM;YAC7D,WAAW,MAAM,MAAM,CAAC,CAAA,IAAK,EAAE,UAAU,KAAK,aAAa,MAAM;QACnE;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS,YAAY,OAAO;YAC5B;YACA,cAAc,YAAY,YAAY;YACtC,UAAU,YAAY,QAAQ,CAAC,KAAK,CAAC,GAAG;YACxC,OAAO,MAAM,KAAK,CAAC,GAAG;YACtB,SAAS,YAAY,QAAQ,CAAC,MAAM,GAAG;QACzC;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,wBAAwB;QACtC,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAA+B,GACxC;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}