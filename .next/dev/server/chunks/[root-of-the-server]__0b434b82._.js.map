{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/jrbuenaventura/Windsurf/Mesanova/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from \"@supabase/ssr\"\nimport { cookies } from \"next/headers\"\n\nexport async function createClient() {\n  const cookieStore = await cookies()\n\n  const supabaseUrl = process.env.SUPABASE_URL || process.env.NEXT_PUBLIC_SUPABASE_URL\n  const supabaseAnonKey = process.env.SUPABASE_ANON_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY\n\n  if (!supabaseUrl || !supabaseAnonKey) {\n    throw new Error(\"Missing Supabase environment variables\")\n  }\n\n  const client = createServerClient(supabaseUrl, supabaseAnonKey, {\n    cookies: {\n      getAll() {\n        return cookieStore.getAll()\n      },\n      setAll(cookiesToSet) {\n        try {\n          cookiesToSet.forEach(({ name, value, options }) => cookieStore.set(name, value, options))\n        } catch {\n          // The \"setAll\" method was called from a Server Component.\n          // This can be ignored if you have proxy refreshing user sessions.\n        }\n      },\n    },\n    auth: {\n      detectSessionInUrl: true,\n      flowType: \"pkce\",\n    },\n    global: {\n      headers: {\n        \"X-Client-Info\": \"mesanova-web-server@1.0.0\",\n      },\n    },\n  })\n\n  return client\n}\n"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;;;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,4IAAO;IAEjC,MAAM,cAAc,QAAQ,GAAG,CAAC,YAAY;IAC5C,MAAM,kBAAkB,QAAQ,GAAG,CAAC,iBAAiB;IAErD;;IAIA,MAAM,SAAS,IAAA,iMAAkB,EAAC,aAAa,iBAAiB;QAC9D,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAAK,YAAY,GAAG,CAAC,MAAM,OAAO;gBAClF,EAAE,OAAM;gBACN,0DAA0D;gBAC1D,kEAAkE;gBACpE;YACF;QACF;QACA,MAAM;YACJ,oBAAoB;YACpB,UAAU;QACZ;QACA,QAAQ;YACN,SAAS;gBACP,iBAAiB;YACnB;QACF;IACF;IAEA,OAAO;AACT"}},
    {"offset": {"line": 91, "column": 0}, "map": {"version":3,"sources":["file:///Users/jrbuenaventura/Windsurf/Mesanova/lib/supabase/admin.ts"],"sourcesContent":["import \"server-only\"\n\nimport { createClient } from \"@supabase/supabase-js\"\n\nexport function createAdminClient() {\n  const supabaseUrl = process.env.SUPABASE_URL || process.env.NEXT_PUBLIC_SUPABASE_URL\n  const serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY\n\n  if (!supabaseUrl || !serviceRoleKey) {\n    throw new Error(\"Missing Supabase admin environment variables\")\n  }\n\n  return createClient(supabaseUrl, serviceRoleKey, {\n    auth: {\n      autoRefreshToken: false,\n      persistSession: false,\n    },\n    global: {\n      headers: {\n        \"X-Client-Info\": \"mesanova-web-admin@1.0.0\",\n      },\n    },\n  })\n}\n"],"names":[],"mappings":";;;;AAAA;AAEA;;;AAEO,SAAS;IACd,MAAM,cAAc,QAAQ,GAAG,CAAC,YAAY;IAC5C,MAAM,iBAAiB,QAAQ,GAAG,CAAC,yBAAyB;IAE5D,IAAI,CAAC,eAAe,CAAC,gBAAgB;QACnC,MAAM,IAAI,MAAM;IAClB;IAEA,OAAO,IAAA,gMAAY,EAAC,aAAa,gBAAgB;QAC/C,MAAM;YACJ,kBAAkB;YAClB,gBAAgB;QAClB;QACA,QAAQ;YACN,SAAS;gBACP,iBAAiB;YACnB;QACF;IACF;AACF"}},
    {"offset": {"line": 121, "column": 0}, "map": {"version":3,"sources":["file:///Users/jrbuenaventura/Windsurf/Mesanova/app/api/admin/aliados/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\nimport { createClient } from \"@/lib/supabase/server\"\nimport { createAdminClient } from \"@/lib/supabase/admin\"\n\ntype CreateAliadoBody = {\n  email: string\n  company_name: string\n  contact_name?: string\n  phone?: string\n  commission_percentage?: string | number\n  is_active?: boolean\n}\n\nexport async function POST(req: Request) {\n  try {\n    const supabase = await createClient()\n\n    const {\n      data: { user },\n    } = await supabase.auth.getUser()\n\n    if (!user) {\n      return NextResponse.json({ error: \"No autenticado\" }, { status: 401 })\n    }\n\n    const { data: profile, error: profileError } = await supabase\n      .from(\"user_profiles\")\n      .select(\"role\")\n      .eq(\"id\", user.id)\n      .single()\n\n    if (profileError) {\n      return NextResponse.json({ error: profileError.message }, { status: 500 })\n    }\n\n    if (profile?.role !== \"superadmin\") {\n      return NextResponse.json({ error: \"No autorizado\" }, { status: 403 })\n    }\n\n    const body = (await req.json()) as CreateAliadoBody\n\n    const email = (body.email || \"\").trim().toLowerCase()\n    const company_name = (body.company_name || \"\").trim()\n\n    if (!email) {\n      return NextResponse.json({ error: \"Email requerido\" }, { status: 400 })\n    }\n\n    if (!company_name) {\n      return NextResponse.json({ error: \"Nombre de empresa requerido\" }, { status: 400 })\n    }\n\n    const admin = createAdminClient()\n\n    // Evitar flujo ambiguo si el usuario ya existe\n    const { data: usersData } = await admin.auth.admin.listUsers()\n    const existingUser = usersData?.users?.find((u) => (u.email || \"\").toLowerCase() === email)\n    if (existingUser) {\n      return NextResponse.json(\n        {\n          error:\n            \"Ya existe un usuario con ese email. Edita el aliado existente o elimina el usuario primero si deseas re-invitar.\",\n        },\n        { status: 400 }\n      )\n    }\n\n    const { data, error } = await admin.auth.admin.inviteUserByEmail(email, {\n      data: {\n        role: \"aliado\",\n        full_name: body.contact_name || null,\n      },\n      redirectTo: `${process.env.NEXT_PUBLIC_SITE_URL || \"http://localhost:3000\"}/auth/callback`,\n    })\n\n    if (error) {\n      return NextResponse.json({ error: error.message }, { status: 400 })\n    }\n\n    const invitedUserId = data?.user?.id\n\n    if (!invitedUserId) {\n      return NextResponse.json({ error: \"No se pudo crear el usuario\" }, { status: 500 })\n    }\n\n    const commission =\n      typeof body.commission_percentage === \"string\"\n        ? Number.parseFloat(body.commission_percentage)\n        : typeof body.commission_percentage === \"number\"\n          ? body.commission_percentage\n          : 0\n\n    const { error: profileUpsertError } = await admin.from(\"user_profiles\").upsert({\n      id: invitedUserId,\n      role: \"aliado\",\n      full_name: body.contact_name || null,\n      phone: body.phone || null,\n    })\n\n    if (profileUpsertError) {\n      return NextResponse.json({ error: profileUpsertError.message }, { status: 400 })\n    }\n\n    const { error: aliadoError } = await admin.from(\"aliados\").insert({\n      user_id: invitedUserId,\n      company_name,\n      contact_name: body.contact_name || null,\n      phone: body.phone || null,\n      email,\n      total_sales: 0,\n      commission_percentage: Number.isFinite(commission) ? commission : 0,\n      is_active: body.is_active ?? true,\n    })\n\n    if (aliadoError) {\n      return NextResponse.json({ error: aliadoError.message }, { status: 400 })\n    }\n\n    return NextResponse.json({ success: true })\n  } catch (e) {\n    const message = e instanceof Error ? e.message : \"Unknown error\"\n    return NextResponse.json({ error: message }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAWO,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,WAAW,MAAM,IAAA,2IAAY;QAEnC,MAAM,EACJ,MAAM,EAAE,IAAI,EAAE,EACf,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO;QAE/B,IAAI,CAAC,MAAM;YACT,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAiB,GAAG;gBAAE,QAAQ;YAAI;QACtE;QAEA,MAAM,EAAE,MAAM,OAAO,EAAE,OAAO,YAAY,EAAE,GAAG,MAAM,SAClD,IAAI,CAAC,iBACL,MAAM,CAAC,QACP,EAAE,CAAC,MAAM,KAAK,EAAE,EAChB,MAAM;QAET,IAAI,cAAc;YAChB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO,aAAa,OAAO;YAAC,GAAG;gBAAE,QAAQ;YAAI;QAC1E;QAEA,IAAI,SAAS,SAAS,cAAc;YAClC,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAgB,GAAG;gBAAE,QAAQ;YAAI;QACrE;QAEA,MAAM,OAAQ,MAAM,IAAI,IAAI;QAE5B,MAAM,QAAQ,CAAC,KAAK,KAAK,IAAI,EAAE,EAAE,IAAI,GAAG,WAAW;QACnD,MAAM,eAAe,CAAC,KAAK,YAAY,IAAI,EAAE,EAAE,IAAI;QAEnD,IAAI,CAAC,OAAO;YACV,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAkB,GAAG;gBAAE,QAAQ;YAAI;QACvE;QAEA,IAAI,CAAC,cAAc;YACjB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA8B,GAAG;gBAAE,QAAQ;YAAI;QACnF;QAEA,MAAM,QAAQ,IAAA,+IAAiB;QAE/B,+CAA+C;QAC/C,MAAM,EAAE,MAAM,SAAS,EAAE,GAAG,MAAM,MAAM,IAAI,CAAC,KAAK,CAAC,SAAS;QAC5D,MAAM,eAAe,WAAW,OAAO,KAAK,CAAC,IAAM,CAAC,EAAE,KAAK,IAAI,EAAE,EAAE,WAAW,OAAO;QACrF,IAAI,cAAc;YAChB,OAAO,gJAAY,CAAC,IAAI,CACtB;gBACE,OACE;YACJ,GACA;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,MAAM,IAAI,CAAC,KAAK,CAAC,iBAAiB,CAAC,OAAO;YACtE,MAAM;gBACJ,MAAM;gBACN,WAAW,KAAK,YAAY,IAAI;YAClC;YACA,YAAY,GAAG,6DAAoC,wBAAwB,cAAc,CAAC;QAC5F;QAEA,IAAI,OAAO;YACT,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO,MAAM,OAAO;YAAC,GAAG;gBAAE,QAAQ;YAAI;QACnE;QAEA,MAAM,gBAAgB,MAAM,MAAM;QAElC,IAAI,CAAC,eAAe;YAClB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA8B,GAAG;gBAAE,QAAQ;YAAI;QACnF;QAEA,MAAM,aACJ,OAAO,KAAK,qBAAqB,KAAK,WAClC,OAAO,UAAU,CAAC,KAAK,qBAAqB,IAC5C,OAAO,KAAK,qBAAqB,KAAK,WACpC,KAAK,qBAAqB,GAC1B;QAER,MAAM,EAAE,OAAO,kBAAkB,EAAE,GAAG,MAAM,MAAM,IAAI,CAAC,iBAAiB,MAAM,CAAC;YAC7E,IAAI;YACJ,MAAM;YACN,WAAW,KAAK,YAAY,IAAI;YAChC,OAAO,KAAK,KAAK,IAAI;QACvB;QAEA,IAAI,oBAAoB;YACtB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO,mBAAmB,OAAO;YAAC,GAAG;gBAAE,QAAQ;YAAI;QAChF;QAEA,MAAM,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,MAAM,IAAI,CAAC,WAAW,MAAM,CAAC;YAChE,SAAS;YACT;YACA,cAAc,KAAK,YAAY,IAAI;YACnC,OAAO,KAAK,KAAK,IAAI;YACrB;YACA,aAAa;YACb,uBAAuB,OAAO,QAAQ,CAAC,cAAc,aAAa;YAClE,WAAW,KAAK,SAAS,IAAI;QAC/B;QAEA,IAAI,aAAa;YACf,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO,YAAY,OAAO;YAAC,GAAG;gBAAE,QAAQ;YAAI;QACzE;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;QAAK;IAC3C,EAAE,OAAO,GAAG;QACV,MAAM,UAAU,aAAa,QAAQ,EAAE,OAAO,GAAG;QACjD,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAQ,GAAG;YAAE,QAAQ;QAAI;IAC7D;AACF"}}]
}